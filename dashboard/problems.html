<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PT Identifier - AutoVitals Tech Support Command Center</title>
<link rel="icon" href="assets/av-icon-green.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared/styles.css">
<style>
.suggestion-card {
  background: var(--bg-card); border: 1px solid var(--border); border-left: 4px solid var(--accent-yellow);
  border-radius: var(--radius); padding: 16px 20px; box-shadow: var(--shadow);
}
.suggestion-card.created { border-left-color: var(--av-green); opacity: 0.6; }
.jira-key {
  font-family: var(--font-mono); font-weight: 700; font-size: 0.95rem; color: var(--av-blue);
}
.ticket-chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 10px 0; }
.ticket-chip {
  font-family: var(--font-mono); font-size: 0.72rem; font-weight: 600;
  padding: 3px 8px; border-radius: 4px; background: var(--bg-input);
  border: 1px solid var(--border-subtle);
}
.ticket-chip a { color: var(--av-blue); text-decoration: none; }
.ticket-chip a:hover { text-decoration: underline; }
.ticket-chip.has-pt { border-color: var(--av-green); background: rgba(117,194,154,0.08); }
.ticket-chip.no-pt { border-color: var(--accent-yellow); background: rgba(240,192,80,0.08); }
.suggestion-meta {
  display: flex; gap: 12px; flex-wrap: wrap; font-size: 0.75rem; color: var(--text-muted);
  margin-bottom: 10px;
}
.suggestion-meta strong { color: var(--text-secondary); }
.suggestion-actions { display: flex; gap: 8px; align-items: center; margin-top: 12px; }
.scan-info {
  font-size: 0.75rem; color: var(--text-muted); font-family: var(--font-mono);
}
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/av-logo-white.png" alt="AutoVitals" class="header-logo">
    <div class="header-divider"></div>
    <div>
      <div class="header-title">Tech Support Command Center</div>
      <div class="header-subtitle" id="header-sub">PT Identifier</div>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge"></div>
    <button class="btn btn-primary" onclick="loadSuggestions()" id="refresh-btn">Scan</button>
    <div class="last-updated" id="last-updated">--</div>
  </div>
</header>

<div class="dashboard">
  <section>
    <div class="section-header">
      <div class="section-title">Suggested Problem Tickets</div>
      <div class="scan-info" id="scan-info">--</div>
    </div>
    <div id="suggestions-box"><div class="loading-shimmer" style="height:200px"></div></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script src="shared/utils.js"></script>
<script src="shared/nav.js"></script>
<script>
(function(){
'use strict';

var suggestionsData = null;
var dismissedKeys = {};
try { dismissedKeys = JSON.parse(localStorage.getItem('pt_dismissed') || '{}'); } catch(e) {}

// ---- Load suggestions ----
window.loadSuggestions = function(){
  var btn = document.getElementById('refresh-btn');
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Scanning...';

  CC.api('pt-suggestions?days=14').then(function(d){
    if(!d) return;
    suggestionsData = d;
    renderSuggestions(d);
    document.getElementById('last-updated').textContent = 'Scanned ' + CC.fmtTime(d.generatedAt);
    document.getElementById('scan-info').textContent = d.scannedTickets + ' tickets scanned | ' + (d.jiraLinkedTickets || 0) + ' with Jira (' + d.days + ' days)';

    var count = (d.suggestions || []).filter(function(s){ return !dismissedKeys[s.issueKey]; }).length;
    var el = document.getElementById('status-badge');
    if(count === 0){
      el.innerHTML = '<span class="status-badge status-green"><span class="dot"></span>No Suggestions</span>';
    } else {
      el.innerHTML = '<span class="status-badge status-yellow"><span class="dot"></span>' + count + ' Suggestion' + (count > 1 ? 's' : '') + '</span>';
    }

    btn.classList.remove('loading');
    btn.textContent = 'Scan';
  }).catch(function(e){
    CC.toast('Error: ' + e.message, false);
    btn.classList.remove('loading');
    btn.textContent = 'Scan';
  });
};

// ---- Render ----
function renderSuggestions(d){
  var box = document.getElementById('suggestions-box');
  var items = (d.suggestions || []).filter(function(s){ return !dismissedKeys[s.issueKey]; });

  if(!items.length){
    box.innerHTML = '<div class="all-clear fade-in"><div class="title">No Suggestions</div>' +
      '<div class="sub">All Jira-linked tickets are properly grouped or have fewer than 2 matches</div></div>';
    return;
  }

  var h = '<div style="display:grid;grid-template-columns:1fr;gap:14px" class="fade-in">';

  items.forEach(function(s, idx){
    h += '<div class="suggestion-card" id="sug-' + CC.esc(s.issueKey) + '">';

    // Header: Jira key + ticket count
    h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">';
    h += '<div>';
    h += '<a href="' + CC.esc(s.jiraUrl) + '" target="_blank" class="jira-key">' + CC.esc(s.issueKey) + '</a>';
    h += '</div>';
    h += '<div style="text-align:right">';
    h += '<div style="font-family:var(--font-mono);font-size:1.2rem;font-weight:800;color:var(--accent-yellow);line-height:1">' + s.totalTickets + '</div>';
    h += '<div style="font-size:0.62rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.04em">tickets</div>';
    h += '</div>';
    h += '</div>';

    // Meta
    h += '<div class="suggestion-meta">';
    h += '<span><strong>' + s.unlinkedCount + '</strong> unlinked (no PT)</span>';
    h += '<span><strong>' + (s.totalTickets - s.unlinkedCount) + '</strong> already linked</span>';
    h += '</div>';

    // Ticket chips
    h += '<div class="ticket-chips">';
    s.tickets.forEach(function(t){
      var cls = t.problemId ? 'has-pt' : 'no-pt';
      var title = t.problemId ? 'Linked to PT#' + t.problemId : 'No Problem Ticket';
      h += '<span class="ticket-chip ' + cls + '" title="' + title + '">';
      h += '<a href="' + CC.ZD + t.id + '" target="_blank">#' + t.id + '</a>';
      h += ' <span style="font-size:0.62rem;color:var(--text-muted)">' + CC.esc(t.status) + '</span>';
      h += '</span>';
    });
    h += '</div>';

    // Actions
    h += '<div class="suggestion-actions">';
    h += '<button class="btn btn-approve" id="create-btn-' + idx + '" onclick="createPT(' + idx + ',this)">Create Problem Ticket</button>';
    h += '<button class="btn btn-muted btn-sm" onclick="dismissSuggestion(\'' + CC.esc(s.issueKey) + '\')">Dismiss</button>';
    h += '<span id="create-status-' + idx + '" style="font-size:0.75rem;color:var(--text-muted)"></span>';
    h += '</div>';

    h += '</div>';
  });

  h += '</div>';
  box.innerHTML = h;
}

// ---- Create Problem Ticket ----
window.createPT = function(idx, btn){
  var items = (suggestionsData.suggestions || []).filter(function(s){ return !dismissedKeys[s.issueKey]; });
  var s = items[idx];
  if(!s) return;

  var status = document.getElementById('create-status-' + idx);
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Creating...';

  // Collect unlinked ticket IDs
  var unlinkedIds = s.tickets.filter(function(t){ return !t.problemId; }).map(function(t){ return t.id; });

  CC.api('create-problem', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      subject: s.issueKey + ': Problem Ticket (auto-suggested)',
      description: 'Auto-created Problem Ticket.\n\nJira: ' + s.jiraUrl + '\nTickets: ' + unlinkedIds.join(', '),
      tags: ['auto-pt', 'jira-linked'],
      ticketIds: unlinkedIds,
      jiraIssueId: s.issueId,
      jiraIssueKey: s.issueKey,
    })
  }).then(function(d){
    if(d && d.success){
      var card = document.getElementById('sug-' + s.issueKey);
      if(card) card.classList.add('created');
      btn.classList.remove('loading');
      btn.disabled = true;
      btn.textContent = 'Created';
      btn.classList.remove('btn-approve');

      status.innerHTML = '<a href="' + CC.esc(d.zdUrl) + '" target="_blank" style="color:var(--av-green);font-weight:600">ZD#' + d.problemId + '</a> â€” ' + d.linkedCount + ' tickets linked';

      CC.toast('Problem Ticket #' + d.problemId + ' created with ' + d.linkedCount + ' linked tickets', true);
    } else {
      throw new Error('Unexpected response');
    }
  }).catch(function(e){
    CC.toast('Error: ' + e.message, false);
    btn.classList.remove('loading');
    btn.textContent = 'Create Problem Ticket';
    status.textContent = 'Failed: ' + e.message;
    status.style.color = 'var(--accent-red)';
  });
};

// ---- Dismiss ----
window.dismissSuggestion = function(issueKey){
  dismissedKeys[issueKey] = true;
  localStorage.setItem('pt_dismissed', JSON.stringify(dismissedKeys));
  var card = document.getElementById('sug-' + issueKey);
  if(card) card.remove();

  // Check if any left
  var remaining = document.querySelectorAll('.suggestion-card:not(.created)');
  if(remaining.length === 0){
    document.getElementById('suggestions-box').innerHTML =
      '<div class="all-clear fade-in"><div class="title">No Suggestions</div>' +
      '<div class="sub">All suggestions dismissed or created</div></div>';
  }
  CC.toast('Dismissed ' + issueKey, true);
};

// ---- Init ----
loadSuggestions();

})();
</script>
</body>
</html>
