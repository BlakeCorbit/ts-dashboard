<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Approval Queue - AutoVitals Tech Support Command Center</title>
<link rel="icon" href="assets/av-icon-green.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared/styles.css">
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/av-logo-white.png" alt="AutoVitals" class="header-logo">
    <div class="header-divider"></div>
    <div>
      <div class="header-title">Tech Support Command Center</div>
      <div class="header-subtitle" id="header-sub">Approval Queue</div>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge"></div>
    <button class="btn btn-primary" onclick="renderQueue()" id="refresh-btn">Refresh</button>
    <div class="last-updated" id="last-updated">--</div>
  </div>
</header>

<div class="dashboard">
  <section>
    <div class="section-header">
      <div class="section-title">Pending Approval</div>
      <div style="display:flex;gap:8px">
        <span style="font-size:0.78rem;color:var(--text-muted)" id="queue-count"></span>
        <button class="btn btn-sm btn-danger" onclick="clearQueue()">Clear All</button>
      </div>
    </div>
    <div id="approval-box"><div class="loading-shimmer"></div></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script src="shared/auth.js"></script>
<script src="shared/utils.js"></script>
<script src="shared/nav.js"></script>
<script>
(function(){
'use strict';

function getQueue(){
  return JSON.parse(localStorage.getItem('approvalQueue') || '[]');
}

function saveQueue(queue){
  localStorage.setItem('approvalQueue', JSON.stringify(queue));
  if(typeof updateApprovalBadge === 'function') updateApprovalBadge();
}

window.renderQueue = function(){
  var queue = getQueue();
  var box = document.getElementById('approval-box');
  var countEl = document.getElementById('queue-count');
  countEl.textContent = queue.length + ' item' + (queue.length !== 1 ? 's' : '');
  document.getElementById('last-updated').textContent = 'Updated ' + CC.fmtTime(new Date().toISOString());

  if(queue.length === 0){
    box.innerHTML = '<div class="all-clear fade-in" style="padding:50px">' +
      '<div style="font-size:2.5rem;margin-bottom:12px;color:var(--av-green)">&#10003;</div>' +
      '<div class="title">No Items Waiting for Approval</div>' +
      '<div class="sub">Detected problem clusters will appear here when sent from the Problem Tickets page</div>' +
      '</div>';
    return;
  }

  var h = '<div class="fade-in">';
  queue.forEach(function(item, idx){
    var cardId = 'approval-card-' + idx;
    h += '<div class="approval-card" id="' + cardId + '">';
    h += '<div class="cluster-header">';
    h += '<div class="cluster-pattern">' + CC.esc(item.pattern) + '</div>';
    h += '<span class="age-pill age-ok">' + CC.relTime(item.addedAt) + '</span>';
    h += '</div>';

    h += '<div class="cluster-stats">';
    h += '<strong>' + (item.ticketCount || 0) + '</strong> tickets';
    if(item.orgCount) h += ' across <strong>' + item.orgCount + '</strong> orgs';
    if(item.timeSpan) h += ' &middot; ' + CC.esc(item.timeSpan);
    h += '</div>';

    // Ticket chips
    if(item.ticketIds && item.ticketIds.length){
      h += '<div class="cluster-tickets">';
      item.ticketIds.forEach(function(tid){
        h += '<span class="cluster-ticket-chip"><a href="' + CC.ZD + tid + '" target="_blank">#' + tid + '</a></span>';
      });
      h += '</div>';
    }

    // Editable form
    h += '<div class="approval-form" id="form-' + idx + '">';
    h += '<label>Subject</label>';
    h += '<input type="text" id="subj-' + idx + '" value="' + CC.esc(item.suggestedSubject || '') + '">';
    h += '<label>Description</label>';
    h += '<textarea id="desc-' + idx + '">' + CC.esc(item.suggestedDescription || '') + '</textarea>';
    h += '</div>';

    // Actions
    h += '<div style="display:flex;gap:8px;margin-top:16px">';
    h += '<button class="btn btn-approve" onclick="approveItem(' + idx + ',this)" id="approve-btn-' + idx + '">Approve &amp; Create</button>';
    h += '<button class="btn btn-muted" onclick="dismissItem(' + idx + ')">Dismiss</button>';
    h += '</div>';

    // Result area (hidden initially)
    h += '<div id="result-' + idx + '"></div>';
    h += '</div>';
  });
  h += '</div>';
  box.innerHTML = h;
};

window.approveItem = function(idx, btn){
  var queue = getQueue();
  var item = queue[idx];
  if(!item) return;

  var subject = document.getElementById('subj-' + idx).value.trim();
  var description = document.getElementById('desc-' + idx).value.trim();

  if(!subject){
    CC.toast('Subject is required', false);
    return;
  }

  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Creating...';

  var payload = {
    subject: subject,
    description: description,
    ticketIds: item.ticketIds || [],
    pattern: item.pattern
  };

  CC.api('create-problem', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  }).then(function(d){
    if(d && d.success){
      var problemId = d.problemId || d.ticketId || '?';
      var jiraLinks = d.jiraLinks || [];

      // Update card to success state
      var card = document.getElementById('approval-card-' + idx);
      card.classList.add('approved');

      // Hide form and buttons
      var form = document.getElementById('form-' + idx);
      form.style.display = 'none';
      btn.parentNode.style.display = 'none';

      // Show result
      var resultEl = document.getElementById('result-' + idx);
      var rh = '<div style="margin-top:16px">';
      rh += '<div style="font-size:1rem;font-weight:700;color:var(--av-green);margin-bottom:8px">';
      rh += 'Problem <a href="' + CC.ZD + problemId + '" target="_blank" style="color:var(--av-green)">ZD#' + problemId + '</a> Created';
      rh += '</div>';

      // Jira links
      if(jiraLinks.length){
        rh += '<div style="margin-bottom:8px;font-size:0.82rem">';
        jiraLinks.forEach(function(j){
          rh += '<span style="margin-right:12px"><span style="color:var(--text-muted)">Jira:</span> <a href="' + CC.esc(j.url || CC.JIRA + j.issueKey) + '" target="_blank"><strong>' + CC.esc(j.issueKey) + '</strong></a></span>';
        });
        rh += '</div>';
      }

      // Reply template
      var replyText = d.replyTemplate || buildReplyTemplate(subject, problemId, jiraLinks);
      rh += '<div class="reply-template">';
      rh += '<button class="copy-btn" onclick="copyReply(' + idx + ')">Copy</button>';
      rh += '<div id="reply-text-' + idx + '">' + CC.esc(replyText) + '</div>';
      rh += '</div>';
      rh += '</div>';
      resultEl.innerHTML = rh;

      // Remove from queue
      queue.splice(idx, 1);
      saveQueue(queue);

      CC.toast('Problem ticket #' + problemId + ' created', true);

      // Re-render after a short delay so user can see result
      setTimeout(function(){ renderQueue(); }, 8000);
    } else {
      CC.toast('Failed to create problem ticket', false);
      btn.classList.remove('loading');
      btn.innerHTML = 'Approve &amp; Create';
    }
  }).catch(function(e){
    CC.toast(e.message, false);
    btn.classList.remove('loading');
    btn.innerHTML = 'Approve &amp; Create';
  });
};

function buildReplyTemplate(subject, problemId, jiraLinks){
  var tpl = 'Hi,\n\n';
  tpl += 'We have identified this as part of a broader issue and created Problem Ticket ZD#' + problemId + ' to track it.\n\n';
  tpl += 'Issue: ' + subject + '\n\n';
  if(jiraLinks && jiraLinks.length){
    tpl += 'Tracking: ' + jiraLinks.map(function(j){ return j.issueKey; }).join(', ') + '\n\n';
  }
  tpl += 'We will update this ticket as progress is made on the underlying issue.\n\n';
  tpl += 'Thank you for your patience.';
  return tpl;
}

window.copyReply = function(idx){
  var el = document.getElementById('reply-text-' + idx);
  if(!el) return;
  var text = el.textContent;
  if(navigator.clipboard){
    navigator.clipboard.writeText(text).then(function(){
      CC.toast('Copied to clipboard', true);
    });
  } else {
    // Fallback
    var ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
    CC.toast('Copied to clipboard', true);
  }
};

window.dismissItem = function(idx){
  var queue = getQueue();
  if(idx < 0 || idx >= queue.length) return;
  var pattern = queue[idx].pattern;
  queue.splice(idx, 1);
  saveQueue(queue);
  CC.toast('Dismissed: ' + pattern, true);
  renderQueue();
};

window.clearQueue = function(){
  var queue = getQueue();
  if(queue.length === 0) return;
  if(!confirm('Clear all ' + queue.length + ' items from the approval queue?')) return;
  localStorage.setItem('approvalQueue', '[]');
  if(typeof updateApprovalBadge === 'function') updateApprovalBadge();
  CC.toast('Queue cleared', true);
  renderQueue();
};

// Update status badge
function updateStatus(){
  var el = document.getElementById('status-badge');
  var queue = getQueue();
  var n = queue.length;
  if(n === 0){
    el.innerHTML = '<span class="status-badge status-green"><span class="dot"></span>Queue Empty</span>';
  } else {
    el.innerHTML = '<span class="status-badge status-yellow"><span class="dot"></span>' + n + ' Pending</span>';
  }
}

// ---- Init ----
renderQueue();
updateStatus();

})();
</script>
</body>
</html>
