<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Churn Risk - AutoVitals Tech Support Command Center</title>
<link rel="icon" href="assets/av-icon-green.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared/styles.css">
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/av-logo-white.png" alt="AutoVitals" class="header-logo">
    <div class="header-divider"></div>
    <div>
      <div class="header-title">Tech Support Command Center</div>
      <div class="header-subtitle" id="header-sub">Churn Early Warning System</div>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge"></div>
    <button class="btn btn-primary" onclick="refreshAll()" id="refresh-btn">Refresh</button>
    <div class="last-updated" id="last-updated">--</div>
  </div>
</header>

<div class="dashboard">
  <!-- Risk Summary -->
  <section>
    <div class="section-header">
      <div class="section-title">Churn Risk Summary</div>
    </div>
    <div class="stats-grid" id="summary-box">
      <div class="loading-shimmer"></div>
      <div class="loading-shimmer"></div>
      <div class="loading-shimmer"></div>
      <div class="loading-shimmer"></div>
    </div>
  </section>

  <!-- Churn Signature Panel (shown when signature data exists) -->
  <section id="signature-section" style="display:none">
    <div class="section-header">
      <div class="section-title">Churn Signature - Learned Patterns</div>
    </div>
    <div id="signature-box"></div>
  </section>

  <!-- Early Warning Predictions (shown when signature data exists) -->
  <section id="predictions-section" style="display:none">
    <div class="section-header">
      <div class="section-title">Early Warning Alerts</div>
      <div style="display:flex;gap:0;border:1px solid var(--border);border-radius:6px;overflow:hidden;width:fit-content">
        <button class="triage-filter active" data-filter="all" onclick="setPredFilter('all',this)">All</button>
        <button class="triage-filter" data-filter="critical" onclick="setPredFilter('critical',this)">Critical</button>
        <button class="triage-filter" data-filter="high" onclick="setPredFilter('high',this)">High</button>
        <button class="triage-filter" data-filter="medium" onclick="setPredFilter('medium',this)">Medium</button>
        <button class="triage-filter" data-filter="low" onclick="setPredFilter('low',this)">Low</button>
      </div>
    </div>
    <div class="triage-card">
      <div class="triage-wrap" id="predictions-box">
        <div class="loading-shimmer" style="height:400px"></div>
      </div>
    </div>
  </section>

  <!-- Risk Distribution Charts -->
  <section>
    <div class="section-header">
      <div class="section-title">Risk Breakdown</div>
    </div>
    <div class="charts-grid" id="charts-box">
      <div class="loading-shimmer" style="height:220px"></div>
      <div class="loading-shimmer" style="height:220px"></div>
    </div>
  </section>

  <!-- Heuristic At-Risk Accounts Table -->
  <section>
    <div class="section-header">
      <div class="section-title">Heuristic Risk Scores</div>
      <div style="display:flex;gap:0;border:1px solid var(--border);border-radius:6px;overflow:hidden;width:fit-content">
        <button class="triage-filter active" data-filter="all" onclick="setFilter('all',this)">All</button>
        <button class="triage-filter" data-filter="critical" onclick="setFilter('critical',this)">Critical</button>
        <button class="triage-filter" data-filter="high" onclick="setFilter('high',this)">High</button>
        <button class="triage-filter" data-filter="medium" onclick="setFilter('medium',this)">Medium</button>
      </div>
    </div>
    <div class="triage-card">
      <div class="triage-wrap" id="accounts-box">
        <div class="loading-shimmer" style="height:400px"></div>
      </div>
    </div>
  </section>

  <!-- Churn Correlation Analysis -->
  <section id="correlation-section" style="display:none">
    <div class="section-header">
      <div class="section-title">Churn Correlation Analysis</div>
    </div>
    <div id="correlation-box"></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script src="shared/utils.js"></script>
<script src="shared/nav.js"></script>
<script>
(function(){
'use strict';

var churnData = null;
var currentFilter = 'all';
var predFilter = 'all';
var sortField = 'riskScore';
var sortAsc = false;
var predSortField = 'churnScore';
var predSortAsc = false;

function riskColor(level) {
  if (level === 'critical') return 'var(--accent-red)';
  if (level === 'high') return 'var(--accent-orange)';
  if (level === 'medium') return 'var(--accent-yellow)';
  return 'var(--av-green)';
}

function riskBg(level) {
  if (level === 'critical') return 'rgba(248,81,73,0.15)';
  if (level === 'high') return 'rgba(232,134,58,0.15)';
  if (level === 'medium') return 'rgba(240,192,80,0.15)';
  return 'rgba(117,194,154,0.15)';
}

function trendArrow(trend) {
  if (trend === 'increasing') return '<span style="color:var(--accent-red);font-weight:700">&#9650;</span>';
  if (trend === 'decreasing') return '<span style="color:var(--av-green);font-weight:700">&#9660;</span>';
  return '<span style="color:var(--text-muted)">&#8212;</span>';
}

function confBadge(conf) {
  var colors = { high: 'var(--av-green)', medium: 'var(--accent-yellow)', low: 'var(--text-muted)' };
  var c = colors[conf] || colors.low;
  return '<span style="font-size:0.65rem;color:' + c + ';font-weight:600;text-transform:uppercase">' + CC.esc(conf || 'low') + '</span>';
}

// ---- Load Data ----
function loadChurnData() {
  CC.api('churn').then(function(d) {
    if (!d) return;
    churnData = d;
    renderSummary(d);
    renderCharts(d);
    renderAccounts(d);
    renderCorrelation(d);
    renderStatus(d);

    // Signature-based sections
    if (d.churnSignature && d.churnSignature.available) {
      renderSignature(d);
      renderPredictions(d);
    }

    document.getElementById('last-updated').textContent = 'Updated ' + CC.fmtTime(d.generatedAt);
  }).catch(function(e) {
    CC.toast('Churn data: ' + e.message, false);
  });
}

// ---- Status Badge ----
function renderStatus(d) {
  var el = document.getElementById('status-badge');
  var hasSignature = d.churnSignature && d.churnSignature.available;

  if (hasSignature && d.predictions) {
    var crit = d.predictions.filter(function(p) { return p.churnRiskLevel === 'critical'; }).length;
    var high = d.predictions.filter(function(p) { return p.churnRiskLevel === 'high'; }).length;
    var total = crit + high;
    var cls, txt;
    if (total === 0) { cls = 'status-green'; txt = 'Low Risk'; }
    else if (crit >= 3) { cls = 'status-red'; txt = crit + ' Critical'; }
    else { cls = 'status-yellow'; txt = total + ' At Risk'; }
    el.innerHTML = '<span class="status-badge ' + cls + '"><span class="dot"></span>' + txt + '</span>';
  } else {
    var s = d.summary;
    var critical = s.critical || 0;
    var high2 = s.high || 0;
    var total2 = critical + high2;
    var cls2, txt2;
    if (total2 === 0) { cls2 = 'status-green'; txt2 = 'Low Risk'; }
    else if (critical >= 3) { cls2 = 'status-red'; txt2 = critical + ' Critical'; }
    else { cls2 = 'status-yellow'; txt2 = total2 + ' At Risk'; }
    el.innerHTML = '<span class="status-badge ' + cls2 + '"><span class="dot"></span>' + txt2 + '</span>';
  }
}

// ---- Summary Cards ----
function renderSummary(d) {
  var box = document.getElementById('summary-box');
  var s = d.summary;
  var sig = d.churnSignature;
  var h = '';

  h += '<div class="stat-card fade-in"><div class="stat-label">Total Accounts</div>';
  h += '<div class="stat-value">' + CC.fmt(s.totalAccounts) + '</div>';
  h += '<div class="stat-detail">' + CC.fmt(s.matched) + ' matched to Zendesk</div></div>';

  if (sig && sig.available && d.predictions) {
    var predCrit = d.predictions.filter(function(p) { return p.churnRiskLevel === 'critical'; }).length;
    var predHigh = d.predictions.filter(function(p) { return p.churnRiskLevel === 'high'; }).length;

    h += '<div class="stat-card fade-in"><div class="stat-label">Early Warnings</div>';
    h += '<div class="stat-value" style="color:var(--accent-red)">' + CC.fmt(predCrit + predHigh) + '</div>';
    h += '<div class="stat-detail">' + predCrit + ' critical, ' + predHigh + ' high</div></div>';

    h += '<div class="stat-card fade-in"><div class="stat-label">Churn Signature</div>';
    h += '<div class="stat-value" style="color:var(--av-blue)">' + CC.fmt(sig.churnedSampleSize) + '</div>';
    h += '<div class="stat-detail">churned accounts learned</div></div>';

    if (sig.modelQuality) {
      h += '<div class="stat-card fade-in"><div class="stat-label">Model Quality</div>';
      h += '<div class="stat-value" style="color:var(--av-blue)">' + sig.modelQuality.f1 + '%</div>';
      h += '<div class="stat-detail">F1 (Recall ' + sig.modelQuality.recall + '% / Prec ' + sig.modelQuality.precision + '%)</div></div>';
    } else {
      h += '<div class="stat-card fade-in"><div class="stat-label">Analysis Window</div>';
      h += '<div class="stat-value">' + sig.windowDays + 'd</div>';
      h += '<div class="stat-detail">pre-churn lookback</div></div>';
    }
  } else {
    h += '<div class="stat-card fade-in"><div class="stat-label">Critical Risk</div>';
    h += '<div class="stat-value" style="color:var(--accent-red)">' + CC.fmt(s.critical) + '</div>';
    h += '<div class="stat-detail">Score &ge; 75</div></div>';

    h += '<div class="stat-card fade-in"><div class="stat-label">High Risk</div>';
    h += '<div class="stat-value" style="color:var(--accent-orange)">' + CC.fmt(s.high) + '</div>';
    h += '<div class="stat-detail">Score 50&ndash;74</div></div>';

    if (s.modelRecall !== null) {
      h += '<div class="stat-card fade-in"><div class="stat-label">Model Recall</div>';
      h += '<div class="stat-value" style="color:var(--av-blue)">' + s.modelRecall + '%</div>';
      h += '<div class="stat-detail">Predicted actual churns</div></div>';
    } else {
      h += '<div class="stat-card fade-in"><div class="stat-label">Medium + Low</div>';
      h += '<div class="stat-value">' + CC.fmt(s.medium + s.low) + '</div>';
      h += '<div class="stat-detail">' + CC.fmt(s.unscored) + ' unscored</div></div>';
    }
  }

  box.innerHTML = h;
}

// ---- Churn Signature Panel ----
function renderSignature(d) {
  var sig = d.churnSignature;
  if (!sig || !sig.available) return;

  document.getElementById('signature-section').style.display = '';
  var box = document.getElementById('signature-box');

  var features = sig.features || [];
  var maxSep = features.length > 0 ? features[0].separation : 1;

  var h = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px" class="fade-in">';

  // Feature importance bars
  h += '<div class="stat-card" style="padding:16px">';
  h += '<div style="font-weight:700;font-size:0.82rem;margin-bottom:12px;color:var(--text-primary)">Signal Importance (Separation)</div>';
  features.forEach(function(f) {
    var pct = maxSep > 0 ? Math.round(f.separation / maxSep * 100) : 0;
    var barColor = f.separation >= 1.0 ? 'var(--accent-red)' : f.separation >= 0.5 ? 'var(--accent-orange)' : 'var(--accent-yellow)';
    h += '<div style="display:flex;align-items:center;margin-bottom:6px;gap:8px">';
    h += '<div style="width:160px;font-size:0.72rem;color:var(--text-secondary);flex-shrink:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + CC.esc(f.label) + '">' + CC.esc(f.label) + '</div>';
    h += '<div style="flex:1;height:14px;background:var(--bg-main);border-radius:3px;overflow:hidden">';
    h += '<div style="height:100%;width:' + pct + '%;background:' + barColor + ';border-radius:3px;transition:width 0.5s"></div>';
    h += '</div>';
    h += '<div style="width:42px;text-align:right;font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted)">' + f.separation.toFixed(2) + '</div>';
    h += '<div style="width:36px;text-align:right;font-family:var(--font-mono);font-size:0.7rem;color:var(--text-muted)">' + (f.weight * 100).toFixed(0) + '%</div>';
    h += '</div>';
  });
  h += '</div>';

  // Early warning signal summary
  h += '<div class="stat-card" style="padding:16px">';
  h += '<div style="font-weight:700;font-size:0.82rem;margin-bottom:12px;color:var(--text-primary)">Top Warning Signals Firing</div>';
  var warnings = d.earlyWarnings || [];
  if (warnings.length > 0) {
    warnings.slice(0, 8).forEach(function(w) {
      h += '<div style="display:flex;align-items:center;margin-bottom:6px;gap:8px">';
      h += '<div style="font-family:var(--font-mono);font-weight:800;font-size:0.85rem;color:var(--accent-red);width:28px;text-align:right">' + w.count + '</div>';
      h += '<div style="font-size:0.72rem;color:var(--text-secondary)">' + CC.esc(w.label) + '</div>';
      h += '</div>';
    });
  } else {
    h += '<div class="no-data" style="padding:20px 0">No warning signals firing</div>';
  }
  h += '</div>';

  h += '</div>';
  box.innerHTML = h;
}

// ---- Predictions Table ----
window.setPredFilter = function(filter, btn) {
  predFilter = filter;
  var section = document.getElementById('predictions-section');
  var btns = section.querySelectorAll('.triage-filter');
  btns.forEach(function(b) {
    if (b === btn) {
      b.classList.add('active');
      b.style.background = 'var(--av-green-dark)';
      b.style.color = '#fff';
    } else {
      b.classList.remove('active');
      b.style.background = 'var(--bg-card)';
      b.style.color = 'var(--text-secondary)';
    }
  });
  if (churnData) renderPredictions(churnData);
};

window.predSortBy = function(field) {
  if (predSortField === field) {
    predSortAsc = !predSortAsc;
  } else {
    predSortField = field;
    predSortAsc = false;
  }
  if (churnData) renderPredictions(churnData);
};

function priorityColor(p) {
  if (p === 'urgent') return 'var(--accent-red)';
  if (p === 'high') return 'var(--accent-orange)';
  if (p === 'normal') return 'var(--text-secondary)';
  return 'var(--text-muted)';
}

function fmtDate(iso) {
  if (!iso) return '--';
  var d = new Date(iso);
  return (d.getMonth() + 1) + '/' + d.getDate() + '/' + String(d.getFullYear()).slice(2);
}

function renderTicketRow(t, isActive) {
  var h = '<div style="display:flex;align-items:center;gap:8px;padding:6px 10px;border-bottom:1px solid var(--border-subtle);font-size:0.72rem">';
  h += '<a href="' + CC.ZD + t.id + '" target="_blank" style="font-family:var(--font-mono);font-weight:600;color:var(--av-blue);flex-shrink:0">#' + t.id + '</a>';
  h += '<span style="color:' + priorityColor(t.priority) + ';font-weight:600;flex-shrink:0;width:48px;text-transform:capitalize">' + CC.esc(t.priority || 'normal') + '</span>';
  h += '<span style="flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="' + CC.esc(t.subject) + '">' + CC.esc(CC.trunc(t.subject, 50)) + '</span>';
  h += '<span style="color:var(--text-muted);flex-shrink:0;width:55px;text-align:right">' + fmtDate(t.created) + '</span>';
  if (!isActive && t.resHours != null) {
    h += '<span style="font-family:var(--font-mono);color:var(--text-muted);flex-shrink:0;width:45px;text-align:right">' + t.resHours + 'h</span>';
  }
  if (isActive) {
    h += '<span style="color:var(--accent-yellow);font-weight:600;flex-shrink:0;width:50px;text-align:right;text-transform:capitalize;font-size:0.65rem">' + CC.esc(t.status) + '</span>';
  }
  h += '</div>';
  return h;
}

window.togglePredDetail = function(idx) {
  var el = document.getElementById('pred-detail-' + idx);
  if (!el) return;
  var arrow = document.getElementById('pred-arrow-' + idx);
  if (el.style.display === 'none') {
    el.style.display = 'block';
    if (arrow) arrow.textContent = '\u25BC';
  } else {
    el.style.display = 'none';
    if (arrow) arrow.textContent = '\u25B6';
  }
};

function renderPredictions(d) {
  if (!d.churnSignature || !d.churnSignature.available || !d.predictions) return;

  document.getElementById('predictions-section').style.display = '';
  var box = document.getElementById('predictions-box');
  var preds = d.predictions || [];

  // Filter
  if (predFilter !== 'all') {
    preds = preds.filter(function(p) { return p.churnRiskLevel === predFilter; });
  }

  // Sort
  preds = preds.slice().sort(function(a, b) {
    var va = a[predSortField], vb = b[predSortField];
    if (va == null) va = 0;
    if (vb == null) vb = 0;
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
    var cmp = va < vb ? -1 : va > vb ? 1 : 0;
    return predSortAsc ? cmp : -cmp;
  });

  if (preds.length === 0) {
    box.innerHTML = '<div class="no-data">No accounts match this filter</div>';
    return;
  }

  var arrow = function(field) {
    if (predSortField !== field) return '';
    return predSortAsc ? ' &#9650;' : ' &#9660;';
  };

  var h = '<table><thead><tr>';
  h += '<th style="width:24px"></th>';
  h += '<th style="cursor:pointer" onclick="predSortBy(\'name\')">Account' + arrow('name') + '</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="predSortBy(\'churnScore\')">Churn Score' + arrow('churnScore') + '</th>';
  h += '<th style="text-align:center">Level</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="predSortBy(\'signalCount\')">Signals' + arrow('signalCount') + '</th>';
  h += '<th style="text-align:center">Confidence</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="predSortBy(\'mrr\')">MRR' + arrow('mrr') + '</th>';
  h += '<th>Warning Signs</th>';
  h += '</tr></thead><tbody>';

  preds.forEach(function(p, idx) {
    var rc = riskColor(p.churnRiskLevel);
    var rb = riskBg(p.churnRiskLevel);
    var hasTickets = (p.activeTickets && p.activeTickets.length > 0) || (p.historicalTickets && p.historicalTickets.length > 0);

    h += '<tr class="fade-in" style="' + (hasTickets ? 'cursor:pointer' : '') + '" onclick="' + (hasTickets ? 'togglePredDetail(' + idx + ')' : '') + '">';

    // Expand arrow
    h += '<td style="text-align:center;width:24px;padding:0 4px">';
    if (hasTickets) {
      h += '<span id="pred-arrow-' + idx + '" style="font-size:0.65rem;color:var(--text-muted);user-select:none">&#9654;</span>';
    }
    h += '</td>';

    // Name
    h += '<td style="font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + CC.esc(p.name) + '">';
    if (p.zdOrgId) {
      h += '<a href="' + CC.ZD.replace('/agent/tickets/', '/agent/organizations/') + p.zdOrgId + '/tickets" target="_blank" onclick="event.stopPropagation()">' + CC.esc(CC.trunc(p.name, 28)) + '</a>';
    } else {
      h += CC.esc(CC.trunc(p.name, 28));
    }
    h += '</td>';

    // Churn Score
    h += '<td style="text-align:center"><span style="font-family:var(--font-mono);font-weight:800;font-size:1.05rem;color:' + rc + '">' + p.churnScore + '</span></td>';

    // Level badge
    h += '<td style="text-align:center"><span class="priority-badge" style="background:' + rb + ';color:' + rc + '">' + CC.esc(p.churnRiskLevel) + '</span></td>';

    // Signal count
    h += '<td style="text-align:center;font-family:var(--font-mono);font-weight:600">' + p.signalCount + '</td>';

    // Confidence
    h += '<td style="text-align:center">' + confBadge(p.confidence) + '</td>';

    // MRR
    h += '<td style="text-align:center;font-family:var(--font-mono)">' + (p.mrr ? '$' + CC.fmt(p.mrr) : '--') + '</td>';

    // Warning signs (matched signals)
    h += '<td style="max-width:320px">';
    if (p.matchedSignals && p.matchedSignals.length > 0) {
      h += '<div style="font-size:0.72rem;color:var(--text-secondary);line-height:1.4">';
      p.matchedSignals.slice(0, 2).forEach(function(s) {
        h += '<div style="margin-bottom:2px">' + CC.esc(s.explanation) + '</div>';
      });
      if (p.matchedSignals.length > 2) {
        h += '<div style="color:var(--text-muted)">+' + (p.matchedSignals.length - 2) + ' more signals</div>';
      }
      h += '</div>';
    } else {
      h += '<span style="color:var(--text-muted);font-size:0.72rem">--</span>';
    }
    h += '</td>';

    h += '</tr>';

    // Expandable detail row
    if (hasTickets) {
      h += '<tr><td colspan="8" style="padding:0;border-top:none">';
      h += '<div id="pred-detail-' + idx + '" style="display:none;padding:8px 16px 12px 40px;background:var(--bg-main);border-top:1px solid var(--border-subtle)">';

      // Active Tickets
      var active = p.activeTickets || [];
      h += '<div style="margin-bottom:' + (active.length > 0 ? '10' : '0') + 'px">';
      h += '<div style="font-size:0.68rem;font-weight:700;color:var(--accent-orange);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;display:flex;align-items:center;gap:6px">';
      h += 'Active Tickets';
      if (active.length > 0) h += '<span style="font-family:var(--font-mono);font-weight:800;background:rgba(232,134,58,0.15);color:var(--accent-orange);border-radius:10px;padding:1px 7px;font-size:0.65rem">' + active.length + '</span>';
      h += '</div>';
      if (active.length > 0) {
        h += '<div style="border:1px solid var(--border-subtle);border-radius:var(--radius);overflow:hidden">';
        active.forEach(function(t) { h += renderTicketRow(t, true); });
        h += '</div>';
      } else {
        h += '<div style="font-size:0.72rem;color:var(--text-muted);padding:2px 0">No active tickets</div>';
      }
      h += '</div>';

      // Historical Tickets
      var hist = p.historicalTickets || [];
      h += '<div>';
      h += '<div style="font-size:0.68rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;display:flex;align-items:center;gap:6px">';
      h += 'Recent Resolved';
      if (hist.length > 0) h += '<span style="font-family:var(--font-mono);font-weight:800;background:var(--bg-input);color:var(--text-muted);border-radius:10px;padding:1px 7px;font-size:0.65rem">' + hist.length + '</span>';
      h += '</div>';
      if (hist.length > 0) {
        h += '<div style="border:1px solid var(--border-subtle);border-radius:var(--radius);overflow:hidden">';
        hist.forEach(function(t) { h += renderTicketRow(t, false); });
        h += '</div>';
      } else {
        h += '<div style="font-size:0.72rem;color:var(--text-muted);padding:2px 0">No resolved tickets in last 6 months</div>';
      }
      h += '</div>';

      h += '</div></td></tr>';
    }
  });

  h += '</tbody></table>';
  box.innerHTML = h;
}

// ---- Charts ----
function renderCharts(d) {
  var box = document.getElementById('charts-box');
  var h = '';

  // Risk distribution bar chart
  h += CC.hBar('Risk Distribution', d.riskDistribution.map(function(r, i) {
    return { name: r.name, count: r.count };
  }));

  // Top risk factors (or early warning signals if available)
  if (d.earlyWarnings && d.earlyWarnings.length > 0) {
    h += CC.hBar('Early Warning Signals', d.earlyWarnings.slice(0, 6).map(function(w) {
      return { name: w.label, count: w.count };
    }));
  } else {
    h += CC.hBar('Top Risk Factors', d.topRiskFactors.slice(0, 6));
  }

  box.innerHTML = h;
}

// ---- Heuristic Accounts Table ----
window.setFilter = function(filter, btn) {
  currentFilter = filter;
  var section = btn.closest('section');
  var btns = section.querySelectorAll('.triage-filter');
  btns.forEach(function(b) {
    if (b === btn) {
      b.classList.add('active');
      b.style.background = 'var(--av-green-dark)';
      b.style.color = '#fff';
    } else {
      b.classList.remove('active');
      b.style.background = 'var(--bg-card)';
      b.style.color = 'var(--text-secondary)';
    }
  });
  if (churnData) renderAccounts(churnData);
};

window.sortBy = function(field) {
  if (sortField === field) {
    sortAsc = !sortAsc;
  } else {
    sortField = field;
    sortAsc = false;
  }
  if (churnData) renderAccounts(churnData);
};

function renderAccounts(d) {
  var box = document.getElementById('accounts-box');
  var accounts = d.accounts || [];

  if (currentFilter !== 'all') {
    accounts = accounts.filter(function(a) { return a.riskLevel === currentFilter; });
  }

  accounts = accounts.slice().sort(function(a, b) {
    var va = a[sortField], vb = b[sortField];
    if (va == null) va = 0;
    if (vb == null) vb = 0;
    if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
    var cmp = va < vb ? -1 : va > vb ? 1 : 0;
    return sortAsc ? cmp : -cmp;
  });

  if (accounts.length === 0) {
    box.innerHTML = '<div class="no-data">No accounts match this filter</div>';
    return;
  }

  var arrow = function(field) {
    if (sortField !== field) return '';
    return sortAsc ? ' &#9650;' : ' &#9660;';
  };

  var h = '<table><thead><tr>';
  h += '<th style="cursor:pointer" onclick="sortBy(\'name\')">Account' + arrow('name') + '</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="sortBy(\'riskScore\')">Score' + arrow('riskScore') + '</th>';
  h += '<th style="text-align:center">Level</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="sortBy(\'tickets30d\')">30d' + arrow('tickets30d') + '</th>';
  h += '<th style="text-align:center">Trend</th>';
  h += '<th>Top Issue</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="sortBy(\'escalations30d\')">Esc' + arrow('escalations30d') + '</th>';
  h += '<th style="cursor:pointer;text-align:center" onclick="sortBy(\'mrr\')">MRR' + arrow('mrr') + '</th>';
  h += '<th>Risk Factors</th>';
  h += '</tr></thead><tbody>';

  accounts.forEach(function(a) {
    var rc = riskColor(a.riskLevel);
    var rb = riskBg(a.riskLevel);

    h += '<tr class="fade-in">';

    h += '<td style="font-weight:600;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="' + CC.esc(a.name) + '">';
    if (a.zdOrgId) {
      h += '<a href="' + CC.ZD.replace('/agent/tickets/', '/agent/organizations/') + a.zdOrgId + '/tickets" target="_blank">' + CC.esc(CC.trunc(a.name, 28)) + '</a>';
    } else {
      h += CC.esc(CC.trunc(a.name, 28));
    }
    if (a.isChurned) h += ' <span style="font-size:0.6rem;color:var(--accent-red);font-weight:700">CHURNED</span>';
    h += '</td>';

    h += '<td style="text-align:center"><span style="font-family:var(--font-mono);font-weight:800;font-size:1.05rem;color:' + rc + '">' + a.riskScore + '</span></td>';
    h += '<td style="text-align:center"><span class="priority-badge" style="background:' + rb + ';color:' + rc + '">' + CC.esc(a.riskLevel) + '</span></td>';
    h += '<td style="text-align:center;font-family:var(--font-mono);font-weight:600">' + (a.tickets30d || 0) + '</td>';
    h += '<td style="text-align:center">' + trendArrow(a.trend) + '</td>';
    h += '<td class="td-cat">' + CC.esc(a.topCategory || '--') + '</td>';
    h += '<td style="text-align:center;font-family:var(--font-mono)">' + (a.escalations30d || 0) + '</td>';
    h += '<td style="text-align:center;font-family:var(--font-mono)">' + (a.mrr ? '$' + CC.fmt(a.mrr) : '--') + '</td>';

    h += '<td style="max-width:280px">';
    if (a.riskFactors && a.riskFactors.length > 0) {
      h += '<div style="font-size:0.72rem;color:var(--text-secondary);line-height:1.4">';
      a.riskFactors.slice(0, 2).forEach(function(f) {
        h += '<div style="margin-bottom:2px">' + CC.esc(f) + '</div>';
      });
      if (a.riskFactors.length > 2) {
        h += '<div style="color:var(--text-muted)">+' + (a.riskFactors.length - 2) + ' more</div>';
      }
      h += '</div>';
    } else {
      h += '<span style="color:var(--text-muted);font-size:0.72rem">--</span>';
    }
    h += '</td>';

    h += '</tr>';
  });

  h += '</tbody></table>';
  box.innerHTML = h;
}

// ---- Churn Correlation ----
function renderCorrelation(d) {
  var c = d.churnCorrelation;
  if (!c || !c.hasChurnData) return;

  document.getElementById('correlation-section').style.display = '';
  var box = document.getElementById('correlation-box');

  var metrics = [
    { label: 'Avg Tickets/Month', churned: c.avgTicketsChurned, active: c.avgTicketsActive, unit: '' },
    { label: 'Escalation Rate', churned: (c.avgEscalationRateChurned * 100).toFixed(0), active: (c.avgEscalationRateActive * 100).toFixed(0), unit: '%' },
    { label: 'Avg Resolution (hrs)', churned: c.avgResolutionChurned, active: c.avgResolutionActive, unit: 'h' },
  ];

  var h = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px" class="fade-in">';

  metrics.forEach(function(m) {
    var churnedVal = m.churned != null ? m.churned : '--';
    var activeVal = m.active != null ? m.active : '--';
    var worse = parseFloat(churnedVal) > parseFloat(activeVal);

    h += '<div class="stat-card">';
    h += '<div class="stat-label">' + CC.esc(m.label) + '</div>';
    h += '<div style="display:flex;justify-content:space-around;margin-top:12px">';

    h += '<div style="text-align:center">';
    h += '<div style="font-family:var(--font-mono);font-size:1.5rem;font-weight:800;color:' + (worse ? 'var(--accent-red)' : 'var(--text-primary)') + '">' + churnedVal + m.unit + '</div>';
    h += '<div style="font-size:0.68rem;color:var(--accent-red);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;margin-top:4px">Churned</div>';
    h += '</div>';

    h += '<div style="width:1px;background:var(--border);margin:0 8px"></div>';

    h += '<div style="text-align:center">';
    h += '<div style="font-family:var(--font-mono);font-size:1.5rem;font-weight:800;color:' + (!worse ? 'var(--av-green)' : 'var(--text-primary)') + '">' + activeVal + m.unit + '</div>';
    h += '<div style="font-size:0.68rem;color:var(--av-green);font-weight:600;text-transform:uppercase;letter-spacing:0.06em;margin-top:4px">Active</div>';
    h += '</div>';

    h += '</div></div>';
  });

  h += '</div>';
  box.innerHTML = h;
}

// ---- Refresh ----
window.refreshAll = function() {
  var btn = document.getElementById('refresh-btn');
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Refreshing...';
  loadChurnData();
  setTimeout(function() {
    btn.classList.remove('loading');
    btn.textContent = 'Refresh';
  }, 1000);
};

// ---- Init ----
loadChurnData();
setInterval(loadChurnData, 5 * 60 * 1000);

})();
</script>
</body>
</html>
