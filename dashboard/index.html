<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoVitals Tech Support Command Center</title>
<link rel="icon" href="assets/av-icon-green.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared/styles.css">
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/av-logo-white.png" alt="AutoVitals" class="header-logo">
    <div class="header-divider"></div>
    <div>
      <div class="header-title">Tech Support Command Center</div>
      <div class="header-subtitle" id="header-sub">Loading...</div>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge"></div>
    <button class="btn btn-primary" onclick="refreshAll()" id="refresh-btn">Refresh All</button>
    <div class="last-updated" id="last-updated">--</div>
  </div>
</header>

<div class="dashboard">
  <!-- Active Incidents -->
  <section class="incidents-section">
    <div class="section-header">
      <div class="section-title">Active Problem Tickets</div>
      <button class="btn btn-sm" onclick="loadIncidents()">Refresh</button>
    </div>
    <div id="incidents-box"><div class="loading-shimmer"></div></div>
  </section>

  <!-- Live Triage Queue -->
  <section>
    <div class="section-header">
      <div class="section-title" style="display:flex;align-items:center;gap:8px">
        Live Triage Queue
        <span id="triage-new-badge" class="nav-badge" style="display:none">0</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="triage-poll-status" style="font-size:0.68rem;color:var(--text-muted);font-family:var(--font-mono)">--</span>
        <button class="btn btn-sm" onclick="loadTriageQueue()">Refresh</button>
      </div>
    </div>
    <div id="triage-filters" style="display:flex;gap:0;margin-bottom:12px;border:1px solid var(--border);border-radius:6px;overflow:hidden;width:fit-content">
      <button class="triage-filter active" data-filter="all" onclick="setTriageFilter('all',this)">All</button>
      <button class="triage-filter" data-filter="matched" onclick="setTriageFilter('matched',this)">Matched</button>
      <button class="triage-filter" data-filter="unmatched" onclick="setTriageFilter('unmatched',this)">No Match</button>
    </div>
    <div id="triage-queue-box"><div class="loading-shimmer" style="height:300px"></div></div>
  </section>

  <!-- Stats -->
  <section>
    <div class="section-header">
      <div class="section-title">Weekly Metrics</div>
      <button class="btn btn-sm" onclick="loadMetrics()">Refresh</button>
    </div>
    <div class="stats-grid" id="stats-box">
      <div class="loading-shimmer"></div><div class="loading-shimmer"></div>
      <div class="loading-shimmer"></div><div class="loading-shimmer"></div>
    </div>
  </section>

  <!-- Charts -->
  <section>
    <div class="section-header"><div class="section-title">Breakdown</div></div>
    <div class="charts-grid" id="charts-box">
      <div class="loading-shimmer" style="height:200px"></div>
      <div class="loading-shimmer" style="height:200px"></div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script src="shared/utils.js"></script>
<script src="shared/nav.js"></script>
<script>
(function(){
'use strict';

var metricsData = null, incidentsData = null;
var triageQueueData = null;
var currentFilter = 'all';
var firstLoad = true;

// Persistent state via localStorage
function loadState(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) || fallback; }
  catch(e) { return fallback; }
}
function saveState(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
}

var seenTicketIds = loadState('triage_seenIds', {});
var dismissedIds = loadState('triage_dismissedIds', {});
var handledIds = loadState('triage_handledIds', {});
var triageFeedback = loadState('triage_feedback', { patterns: {} });

// Prune entries older than 30 days on load
(function pruneOldFeedback() {
  var cutoff = Date.now() - 30 * 24 * 3600000;
  var patterns = triageFeedback.patterns;
  for (var key in patterns) {
    if (new Date(patterns[key].last).getTime() < cutoff) {
      delete patterns[key];
    }
  }
  saveState('triage_feedback', triageFeedback);
})();

function recordFeedback(action, errorPattern, problemId) {
  if (!errorPattern || errorPattern === 'other' || !problemId) return;
  var key = errorPattern + '::' + problemId;
  var entry = triageFeedback.patterns[key] || { approved: 0, dismissed: 0, last: '' };
  if (action === 'dismiss') entry.dismissed++;
  else if (action === 'approve') entry.approved++;
  entry.last = new Date().toISOString();
  triageFeedback.patterns[key] = entry;
  saveState('triage_feedback', triageFeedback);
}

function getFeedbackAdjustment(errorPattern, problemId) {
  if (!errorPattern || errorPattern === 'other' || !problemId) return 'neutral';
  var key = errorPattern + '::' + problemId;
  var entry = triageFeedback.patterns[key];
  if (!entry) return 'neutral';
  var total = entry.approved + entry.dismissed;
  if (total < 3) return 'neutral';
  if (entry.dismissed / total > 0.6) return 'suppress';
  if (entry.approved / total > 0.7) return 'boost';
  return 'neutral';
}

// ---- Incidents ----
window.loadIncidents = function(){
  CC.api('incidents').then(function(d){
    if(!d)return;
    incidentsData=d;
    renderIncidents(d);
    renderStatus(d);
  }).catch(function(e){ CC.toast('Incidents: '+e.message, false); });
};

function renderStatus(d){
  var el=document.getElementById('status-badge');
  var n=(d&&d.incidents)?d.incidents.length:0;
  var cls,txt;
  if(n===0){cls='status-green';txt='All Clear';}
  else if(n>=5){cls='status-red';txt=n+' Problems';}
  else{cls='status-yellow';txt=n+' Problem'+(n>1?'s':'');}
  el.innerHTML='<span class="status-badge '+cls+'"><span class="dot"></span>'+txt+'</span>';
}

function renderIncidents(d){
  var box=document.getElementById('incidents-box');
  if(!d||!d.incidents||d.incidents.length===0){
    box.innerHTML='<div class="all-clear fade-in"><div class="title">All Clear</div><div class="sub">No active problem tickets</div></div>';
    return;
  }
  var h='<div class="incidents-grid fade-in">';
  d.incidents.forEach(function(i){
    var age=CC.ageH(i.createdAt);
    var ac=age>24?'age-critical':age>4?'age-warning':'age-ok';
    var linked=i.linkedCount||0;
    var hasJira=i.jiraLinks&&i.jiraLinks.length>0;
    var pid=i.problemId;

    h+='<div class="incident-card '+ac+'">';
    h+='<div class="incident-header">';
    h+='<span class="incident-id"><a href="'+CC.ZD+pid+'" target="_blank">ZD#'+pid+'</a></span>';
    h+='<span class="age-pill '+ac+'">'+CC.relTime(i.createdAt)+'</span>';
    h+='</div>';
    h+='<div class="incident-subject">'+CC.esc(i.subject)+'</div>';
    h+='<div class="incident-meta">';
    if(hasJira){
      i.jiraLinks.forEach(function(j){
        h+='<span><span class="label">Jira:</span> <a href="'+CC.esc(j.url)+'" target="_blank"><strong>'+CC.esc(j.issueKey)+'</strong></a></span>';
      });
    }
    h+='<span><span class="label">Status:</span> <span class="value">'+CC.esc(i.status)+'</span></span>';
    h+='</div>';

    // Linked tickets toggle (compact)
    if(i.linkedTickets&&i.linkedTickets.length>0){
      h+='<button class="btn btn-sm" onclick="toggleLinked('+pid+',this)" style="margin-top:8px;font-size:0.7rem">'+linked+' Linked</button>';
      h+='<div id="linked-'+pid+'" style="display:none;margin-top:8px">';
      i.linkedTickets.forEach(function(t){
        h+='<div style="border:1px solid var(--border-subtle);border-radius:var(--radius);margin-bottom:6px;overflow:hidden">';
        h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--bg-input);cursor:pointer;gap:8px" onclick="toggleTicketDetail('+t.id+')">';
        h+='<div style="display:flex;align-items:center;gap:8px;min-width:0">';
        h+='<a href="'+CC.ZD+t.id+'" target="_blank" onclick="event.stopPropagation()" style="font-family:var(--font-mono);font-weight:600;color:var(--av-blue);font-size:0.75rem;flex-shrink:0">#'+t.id+'</a>';
        h+='<span style="font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+CC.esc(CC.trunc(t.subject,40))+'</span>';
        h+='</div>';
        h+='<div style="display:flex;gap:4px;flex-shrink:0">';
        if(hasJira) h+='<button class="btn btn-link btn-sm" onclick="event.stopPropagation();propagateJira('+t.id+','+pid+',this)" style="font-size:0.62rem;padding:2px 6px">Jira</button>';
        h+='</div></div>';
        // Expandable detail (hidden)
        h+='<div id="detail-'+t.id+'" style="display:none;padding:10px;border-top:1px solid var(--border-subtle)">';
        h+='<div id="detail-content-'+t.id+'" style="margin-bottom:10px"><div class="loading-shimmer" style="height:50px"></div></div>';
        h+='<div style="border-top:1px solid var(--border-subtle);padding-top:8px">';
        h+='<textarea id="comm-'+t.id+'" style="width:100%;min-height:60px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:var(--font-sub);font-size:0.78rem;resize:vertical;box-sizing:border-box" placeholder="Internal note..."></textarea>';
        h+='<div style="display:flex;gap:6px;margin-top:6px">';
        h+='<button class="btn btn-approve btn-sm" onclick="sendComment('+t.id+',this)" style="font-size:0.68rem">Send Note</button>';
        h+='<span id="comm-status-'+t.id+'" style="font-size:0.68rem;color:var(--text-muted);align-self:center"></span>';
        h+='</div></div></div>';
        h+='</div>';
      });
      h+='</div>';
    } else if(linked>0){
      h+='<div style="font-size:0.72rem;color:var(--text-muted);margin-top:8px">'+linked+' linked</div>';
    }

    h+='</div>';
  });
  h+='</div>';
  box.innerHTML=h;
}

// ---- Live Triage Queue ----
window.loadTriageQueue = function(){
  CC.api('triage-queue?hours=2').then(function(d){
    if(!d) return;

    // Count new tickets since last poll
    var newCount = 0;
    (d.queue || []).forEach(function(item){
      if(!seenTicketIds[item.ticketId]){
        seenTicketIds[item.ticketId] = true;
        if(!firstLoad) newCount++;
      }
    });

    triageQueueData = d;
    firstLoad = false;
    saveState('triage_seenIds', seenTicketIds);

    // Flash new badge
    var badge = document.getElementById('triage-new-badge');
    if(newCount > 0){
      badge.textContent = '+' + newCount;
      badge.style.display = 'inline-flex';
      setTimeout(function(){ badge.style.display = 'none'; }, 8000);
    }

    // Poll timestamp
    document.getElementById('triage-poll-status').textContent =
      d.count + ' tickets | ' + d.matchedCount + ' matched | polled ' + CC.fmtTime(d.generatedAt);

    renderTriageQueue(d);
  }).catch(function(e){ CC.toast('Triage: '+e.message, false); });
};

window.setTriageFilter = function(filter, btn){
  currentFilter = filter;
  var btns = document.querySelectorAll('.triage-filter');
  btns.forEach(function(b){
    if(b === btn){
      b.classList.add('active');
      b.style.background = 'var(--av-green-dark)';
      b.style.color = '#fff';
    } else {
      b.classList.remove('active');
      b.style.background = 'var(--bg-card)';
      b.style.color = 'var(--text-secondary)';
    }
  });
  if(triageQueueData) renderTriageQueue(triageQueueData);
};

function renderTriageQueue(d){
  var box = document.getElementById('triage-queue-box');
  var queue = (d && d.queue) ? d.queue : [];

  // Apply filter + remove dismissed/handled
  var filtered = queue.filter(function(item){
    if(dismissedIds[item.ticketId] || handledIds[item.ticketId]) return false;
    return true;
  });

  // Apply feedback-based learning adjustments
  filtered = filtered.map(function(item) {
    if (!item.match) return item;
    var adj = getFeedbackAdjustment(item.errorPattern, item.match.problemId);
    if (adj === 'suppress') {
      return Object.assign({}, item, { match: null, suggestedReply: null });
    }
    if (adj === 'boost' && item.match.confidence !== 'high') {
      var boosted = Object.assign({}, item.match);
      if (boosted.confidence === 'low') boosted.confidence = 'medium';
      else if (boosted.confidence === 'medium') boosted.confidence = 'high';
      boosted.matchReason = boosted.matchReason + ' (boosted by feedback)';
      return Object.assign({}, item, { match: boosted });
    }
    return item;
  });

  // Apply matched/unmatched filter
  if (currentFilter === 'matched') {
    filtered = filtered.filter(function(item) { return item.match !== null; });
  } else if (currentFilter === 'unmatched') {
    filtered = filtered.filter(function(item) { return item.match === null; });
  }

  if(!filtered.length){
    box.innerHTML = '<div class="all-clear fade-in"><div class="title">Queue Clear</div>' +
      '<div class="sub">No unlinked tickets in the last 2 hours</div></div>';
    return;
  }

  // Sort: high confidence first, then medium, then unmatched, then by age
  var confOrder = {high: 0, medium: 1, low: 2};
  filtered.sort(function(a, b){
    var ca = a.match ? (confOrder[a.match.confidence] != null ? confOrder[a.match.confidence] : 3) : 3;
    var cb = b.match ? (confOrder[b.match.confidence] != null ? confOrder[b.match.confidence] : 3) : 3;
    if(ca !== cb) return ca - cb;
    return new Date(b.createdAt) - new Date(a.createdAt);
  });

  var h = '<div class="triage-queue-grid fade-in">';

  filtered.forEach(function(item){
    var borderColor = item.match
      ? (item.match.confidence === 'high' ? 'var(--av-green)'
        : item.match.confidence === 'medium' ? 'var(--accent-yellow)'
        : 'var(--border)')
      : 'var(--border)';
    var pri = (item.priority || 'normal').toLowerCase();

    h += '<div class="triage-queue-card" id="tq-' + item.ticketId + '" style="border-left:4px solid ' + borderColor + '">';

    // Row 1: Ticket info + dismiss
    h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">';
    h += '<div>';
    h += '<a href="' + CC.ZD + item.ticketId + '" target="_blank" style="font-family:var(--font-mono);font-weight:700;color:var(--av-blue)">#' + item.ticketId + '</a>';
    h += ' <span class="priority-badge p-' + pri + '" style="margin-left:4px">' + CC.esc(pri) + '</span>';
    h += ' <span class="age-pill ' + (CC.ageH(item.createdAt) > 1 ? 'age-warning' : 'age-ok') + '">' + CC.relTime(item.createdAt) + '</span>';
    h += '</div>';
    h += '<button class="btn btn-muted btn-sm" onclick="dismissTriageItem(' + item.ticketId + ')" title="Hide">Dismiss</button>';
    h += '</div>';

    // Subject
    h += '<div style="font-size:0.88rem;font-weight:500;margin-bottom:6px;color:var(--text-primary)">' + CC.esc(item.subject) + '</div>';

    // Badges: category, POS, error pattern
    h += '<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px">';
    if(item.category && item.category !== 'general'){
      h += '<span style="font-size:0.62rem;padding:2px 7px;border-radius:4px;background:rgba(118,195,206,0.12);color:var(--av-blue);font-weight:600;text-transform:uppercase">' + CC.esc(item.category) + '</span>';
    }
    if(item.pos){
      h += '<span style="font-size:0.62rem;padding:2px 7px;border-radius:4px;background:rgba(117,194,154,0.12);color:var(--av-green);font-weight:600">' + CC.esc(item.pos) + '</span>';
    }
    if(item.errorPattern && item.errorPattern !== 'other'){
      h += '<span style="font-size:0.62rem;padding:2px 7px;border-radius:4px;background:rgba(232,134,58,0.12);color:var(--accent-orange);font-weight:600">' + CC.esc(item.errorPattern) + '</span>';
    }
    h += '</div>';

    // Match recommendation
    if(item.match){
      var m = item.match;
      var confBg = m.confidence === 'high' ? 'rgba(117,194,154,0.08)' : 'rgba(240,192,80,0.08)';
      var confColor = m.confidence === 'high' ? 'var(--av-green)' : 'var(--accent-yellow)';

      h += '<div style="background:' + confBg + ';border:1px solid ' + confColor + ';border-radius:6px;padding:10px 14px;margin-bottom:10px">';
      h += '<div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;color:' + confColor + ';margin-bottom:4px;letter-spacing:0.04em">';
      h += CC.esc(m.confidence) + ' match (' + m.score + '%)';
      h += '</div>';
      h += '<div style="font-size:0.84rem;margin-bottom:4px">';
      h += 'Link to <a href="' + CC.ZD + m.problemId + '" target="_blank" style="font-weight:700">ZD#' + m.problemId + '</a>: ' + CC.esc(CC.trunc(m.problemSubject, 60));
      h += '</div>';
      if(m.jiraLinks && m.jiraLinks.length){
        m.jiraLinks.forEach(function(j){
          h += '<span style="font-size:0.72rem;color:var(--text-secondary)">Jira: <a href="' + CC.esc(j.url) + '" target="_blank" style="font-weight:700">' + CC.esc(j.issueKey) + '</a></span> ';
        });
      }
      h += '<div style="font-size:0.68rem;color:var(--text-muted);margin-top:4px">' + CC.esc(m.matchReason) + '</div>';
      h += '</div>';

      // Editable reply
      if(item.suggestedReply){
        h += '<div style="margin-bottom:10px">';
        h += '<label style="display:block;font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Suggested Internal Note</label>';
        h += '<textarea id="reply-' + item.ticketId + '" style="width:100%;min-height:55px;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:var(--font-sub);font-size:0.8rem;resize:vertical;box-sizing:border-box">' + CC.esc(item.suggestedReply) + '</textarea>';
        h += '</div>';
      }

      // Action button
      h += '<button class="btn btn-approve" id="approve-btn-' + item.ticketId + '" onclick="approveAndLink(' + item.ticketId + ',' + m.problemId + ',this)">Approve &amp; Link</button>';

    } else {
      // No match
      h += '<div style="font-size:0.78rem;color:var(--text-muted);padding:6px 0;margin-bottom:6px">No matching Problem Ticket found</div>';
      if(incidentsData && incidentsData.incidents && incidentsData.incidents.length){
        h += '<button class="btn btn-link btn-sm" onclick="showLinkMenu(' + item.ticketId + ',this)">Link Manually</button>';
      }
    }

    h += '</div>';
  });

  h += '</div>';
  box.innerHTML = h;
}

// ---- One-click Approve & Link ----
window.approveAndLink = function(ticketId, problemId, btn){
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Linking...';

  // Look up item for feedback learning
  var queueItem = null;
  if (triageQueueData && triageQueueData.queue) {
    queueItem = triageQueueData.queue.find(function(q) { return q.ticketId === ticketId; });
  }
  var errorPattern = queueItem ? queueItem.errorPattern : null;

  var replyEl = document.getElementById('reply-' + ticketId);
  var replyBody = replyEl ? replyEl.value.trim() : '';

  // Step 1: Link ticket to problem
  CC.api('link', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ ticketId: ticketId, problemId: problemId })
  }).then(function(linkResult){
    if(!linkResult || !linkResult.success) throw new Error('Link failed');

    // Step 2: Post internal note if reply text exists
    if(replyBody){
      return CC.api('comment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          ticketId: ticketId,
          body: replyBody
        })
      });
    }
    return { success: true };
  }).then(function(){
    handledIds[ticketId] = true;
    saveState('triage_handledIds', handledIds);

    // Record feedback locally + persist to Zendesk
    recordFeedback('approve', errorPattern, problemId);
    CC.api('feedback', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        ticketId: ticketId,
        action: 'approve',
        errorPattern: errorPattern,
        problemId: problemId
      })
    }).catch(function() {});

    var card = document.getElementById('tq-' + ticketId);
    if(card){
      card.style.borderLeftColor = 'var(--av-green)';
      card.style.opacity = '0.5';
      card.innerHTML = '<div style="padding:10px;display:flex;align-items:center;gap:8px">' +
        '<span style="color:var(--av-green);font-weight:700;font-size:0.85rem">Linked #' + ticketId + ' to ZD#' + problemId + (replyBody ? ' + note posted' : '') + '</span></div>';
    }
    CC.toast('Linked #' + ticketId + ' to Problem #' + problemId, true);
  }).catch(function(e){
    CC.toast('Error: ' + e.message, false);
    btn.classList.remove('loading');
    btn.innerHTML = 'Approve &amp; Link';
  });
};

// ---- Dismiss ----
window.dismissTriageItem = function(ticketId){
  dismissedIds[ticketId] = true;
  saveState('triage_dismissedIds', dismissedIds);

  // Look up item for feedback learning
  var item = null;
  if (triageQueueData && triageQueueData.queue) {
    item = triageQueueData.queue.find(function(q) { return q.ticketId === ticketId; });
  }

  // Record feedback locally if there was a match
  if (item && item.match) {
    recordFeedback('dismiss', item.errorPattern, item.match.problemId);
  }

  // Persist to Zendesk (fire-and-forget)
  CC.api('feedback', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      ticketId: ticketId,
      action: 'dismiss'
    })
  }).catch(function() {});

  var card = document.getElementById('tq-' + ticketId);
  if(card) card.remove();
};

// ---- Manual link (reused from old triage) ----
window.showLinkMenu = function(ticketId, btn){
  var incidents = incidentsData ? incidentsData.incidents : [];
  if(!incidents.length){ CC.toast('No active incidents', false); return; }
  var menu='<select onchange="linkTicket('+ticketId+',this.value,this)" style="font-size:0.7rem;padding:2px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);border-radius:4px">';
  menu+='<option value="">Pick problem...</option>';
  incidents.forEach(function(i){
    var jira=i.jiraLinks&&i.jiraLinks.length?'('+i.jiraLinks[0].issueKey+')':'';
    menu+='<option value="'+i.problemId+'">ZD#'+i.problemId+' '+jira+' '+CC.esc(CC.trunc(i.subject,30))+'</option>';
  });
  menu+='</select>';
  btn.outerHTML=menu;
};

window.linkTicket = function(ticketId, problemId, sel){
  if(!problemId)return;
  sel.disabled=true;
  CC.api('link',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, problemId:parseInt(problemId,10)})
  }).then(function(d){
    if(d&&d.success){
      handledIds[ticketId] = true;
      saveState('triage_handledIds', handledIds);
      var jira=d.jiraLinks&&d.jiraLinks.length?' + '+d.jiraLinks[0].issueKey:'';
      CC.toast('Linked #'+ticketId+' to Problem #'+problemId+jira, true);
      sel.outerHTML='<span style="color:var(--av-green);font-size:0.7rem;font-weight:600">Linked</span>';
    } else { CC.toast('Link failed', false); sel.disabled=false; }
  }).catch(function(e){ CC.toast(e.message, false); sel.disabled=false; });
};

// ---- Metrics ----
window.loadMetrics = function(){
  CC.api('metrics').then(function(d){
    if(!d)return;
    metricsData=d;
    renderStats(d);
    renderCharts(d);
    document.getElementById('header-sub').textContent=
      d.byDay&&d.byDay.length?d.byDay[0].day+' to '+d.byDay[d.byDay.length-1].day:'Current week';
    document.getElementById('last-updated').textContent='Updated '+CC.fmtTime(d.generatedAt);
  }).catch(function(e){ CC.toast('Metrics: '+e.message, false); });
};

function renderStats(d){
  var box=document.getElementById('stats-box');
  var tq = triageQueueData;
  var cards=[
    {l:'Tickets This Week',v:CC.fmt(d.totalTickets),det:'Resolved: '+CC.fmt(d.resolvedTickets)},
    {l:'Avg Per Day',v:d.avgPerDay?d.avgPerDay.toFixed(1):'--',det:'Period average'},
    {l:'Open Backlog',v:CC.fmt(d.openBacklog),det:'Unresolved tickets'},
    {l:'Queue Match Rate',v:tq?Math.round((tq.matchedCount/Math.max(tq.count,1))*100)+'%':'--',det:tq?tq.matchedCount+'/'+tq.count+' matched':''},
  ];
  var h='';
  cards.forEach(function(c){
    h+='<div class="stat-card fade-in"><div class="stat-label">'+CC.esc(c.l)+'</div><div class="stat-value">'+c.v+'</div><div class="stat-detail">'+CC.esc(c.det)+'</div></div>';
  });
  box.innerHTML=h;
}

function renderCharts(d){
  var box=document.getElementById('charts-box');
  var h='';
  h+='<div class="chart-card fade-in"><div class="chart-title">Tickets by Day</div>';
  if(d.byDay&&d.byDay.length){
    var mx=Math.max.apply(null,d.byDay.map(function(x){return x.count;}));
    h+='<div class="bar-chart-v">';
    d.byDay.forEach(function(x){
      var pct=mx>0?(x.count/mx)*100:0;
      h+='<div class="bar-col"><div class="bar-val">'+x.count+'</div><div class="bar-fill" style="height:'+pct+'%"></div><div class="bar-lbl">'+CC.esc(CC.dayLbl(x.day))+'</div></div>';
    });
    h+='</div>';
  } else h+='<div class="no-data">No data</div>';
  h+='</div>';
  h+=CC.hBar('By Category',d.byCategory);
  h+=CC.hBar('By POS',d.byPOS);
  box.innerHTML=h;
}

// ---- Toggle Linked Tickets ----
window.toggleLinked = function(problemId, btn){
  var el=document.getElementById('linked-'+problemId);
  if(!el)return;
  if(el.style.display==='none'){
    el.style.display='block';
    btn.style.background='var(--av-green-dark)';
    btn.style.color='#fff';
  } else {
    el.style.display='none';
    btn.style.background='';
    btn.style.color='';
  }
};

// ---- Toggle Individual Ticket Detail ----
window.toggleTicketDetail = function(ticketId){
  var el=document.getElementById('detail-'+ticketId);
  if(!el)return;
  if(el.style.display==='none'){
    el.style.display='block';
    loadTicketDetail(ticketId);
  } else {
    el.style.display='none';
  }
};

// ---- Load Ticket Detail (latest comments) ----
function loadTicketDetail(ticketId){
  var box=document.getElementById('detail-content-'+ticketId);
  box.innerHTML='<div class="loading-shimmer" style="height:60px"></div>';
  CC.api('ticket-detail?id='+ticketId).then(function(d){
    if(!d||!d.ticket){box.innerHTML='<div style="color:var(--text-muted);font-size:0.82rem">Failed to load</div>';return;}
    var t=d.ticket;
    var h='<div style="display:flex;gap:16px;flex-wrap:wrap;font-size:0.78rem;color:var(--text-secondary);margin-bottom:10px">';
    h+='<span><strong>Status:</strong> '+CC.esc(t.status)+'</span>';
    h+='<span><strong>Priority:</strong> '+CC.esc(t.priority||'normal')+'</span>';
    h+='<span><strong>Type:</strong> '+CC.esc(t.type||'ticket')+'</span>';
    h+='<span><strong>Updated:</strong> '+CC.relTime(t.updatedAt)+'</span>';
    h+='</div>';
    if(d.comments&&d.comments.length>0){
      h+='<div style="font-size:0.68rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px">Recent Comments (newest first)</div>';
      h+='<div style="max-height:250px;overflow-y:auto">';
      d.comments.slice(0,8).forEach(function(c){
        var badge=c.public?'<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(118,195,206,0.15);color:var(--av-blue);margin-left:6px">PUBLIC</span>':'<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(117,194,154,0.15);color:var(--av-green);margin-left:6px">INTERNAL</span>';
        h+='<div style="border-left:2px solid '+(c.public?'var(--av-blue)':'var(--av-green)')+';padding:6px 10px;margin-bottom:6px;font-size:0.78rem;background:var(--bg-input);border-radius:0 4px 4px 0">';
        h+='<div style="font-size:0.68rem;color:var(--text-muted);margin-bottom:3px">'+CC.relTime(c.createdAt)+badge+'</div>';
        h+='<div style="white-space:pre-wrap;color:var(--text-secondary);max-height:100px;overflow-y:auto">'+CC.esc(CC.trunc(c.body,500))+'</div>';
        h+='</div>';
      });
      h+='</div>';
    } else {
      h+='<div style="color:var(--text-muted);font-size:0.82rem">No comments</div>';
    }
    box.innerHTML=h;
  }).catch(function(e){
    box.innerHTML='<div style="color:var(--accent-red);font-size:0.82rem">Error: '+CC.esc(e.message)+'</div>';
  });
}

// ---- Send Recommended Communication ----
window.sendComment = function(ticketId, btn){
  var textarea=document.getElementById('comm-'+ticketId);
  var status=document.getElementById('comm-status-'+ticketId);
  var body=textarea.value.trim();
  if(!body){CC.toast('Type a message first',false);return;}

  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span> Sending...';
  CC.api('comment',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, body:'--- Recommended Communication ---\n\n'+body+'\n\n-- TS Dashboard'})
  }).then(function(d){
    if(d&&d.success){
      CC.toast('Internal note added to #'+ticketId, true);
      btn.classList.remove('loading');
      btn.textContent='Send as Internal Note';
      textarea.value='';
      status.textContent='Sent '+CC.fmtTime(new Date().toISOString());
      status.style.color='var(--av-green)';
      loadTicketDetail(ticketId);
    } else {
      CC.toast('Failed to send', false);
      btn.classList.remove('loading');
      btn.textContent='Send as Internal Note';
    }
  }).catch(function(e){
    CC.toast(e.message, false);
    btn.classList.remove('loading');
    btn.textContent='Send as Internal Note';
  });
};

// ---- Propagate Jira to Linked Ticket ----
window.propagateJira = function(ticketId, problemId, btn){
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span>';
  CC.api('propagate-jira',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, problemId:problemId})
  }).then(function(d){
    if(d&&d.success){
      var jira=d.jiraLinks&&d.jiraLinks.length?d.jiraLinks[0].issueKey:'';
      CC.toast('Jira '+jira+' added to #'+ticketId, true);
      btn.outerHTML='<span style="color:var(--av-green);font-size:0.7rem;font-weight:600">Done</span>';
    } else {
      CC.toast('Failed to propagate Jira', false);
      btn.classList.remove('loading');
      btn.textContent='Add Jira';
    }
  }).catch(function(e){
    CC.toast(e.message, false);
    btn.classList.remove('loading');
    btn.textContent='Add Jira';
  });
};

// ---- Refresh All ----
window.refreshAll = function(){
  var btn=document.getElementById('refresh-btn');
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span> Refreshing...';
  Promise.all([
    CC.api('incidents').then(function(d){ if(d){incidentsData=d;renderIncidents(d);renderStatus(d);} }),
    CC.api('metrics').then(function(d){ if(d){metricsData=d;renderStats(d);renderCharts(d);document.getElementById('last-updated').textContent='Updated '+CC.fmtTime(d.generatedAt);} }),
    CC.api('triage-queue?hours=2').then(function(d){ if(d){triageQueueData=d;renderTriageQueue(d);} }),
  ]).then(function(){
    btn.classList.remove('loading');
    btn.textContent='Refresh All';
    CC.toast('All data refreshed', true);
  }).catch(function(){
    btn.classList.remove('loading');
    btn.textContent='Refresh All';
  });
};

// ---- Init ----
loadIncidents();
loadMetrics();
loadTriageQueue();

// Triage queue polls every 30s, everything else every 5 min
setInterval(function(){ loadTriageQueue(); }, 30 * 1000);
setInterval(function(){ loadIncidents(); loadMetrics(); }, 5 * 60 * 1000);

})();
</script>
</body>
</html>
