<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoVitals Tech Support Command Center</title>
<link rel="icon" href="assets/av-icon-green.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared/styles.css">
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/av-logo-white.png" alt="AutoVitals" class="header-logo">
    <div class="header-divider"></div>
    <div>
      <div class="header-title">Tech Support Command Center</div>
      <div class="header-subtitle" id="header-sub">Loading...</div>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge"></div>
    <button class="btn btn-primary" onclick="refreshAll()" id="refresh-btn">Refresh All</button>
    <div class="last-updated" id="last-updated">--</div>
  </div>
</header>

<div class="dashboard">
  <!-- Active Incidents -->
  <section class="incidents-section">
    <div class="section-header">
      <div class="section-title">Active Problem Tickets</div>
      <button class="btn btn-sm" onclick="loadIncidents()">Refresh</button>
    </div>
    <div id="incidents-box"><div class="loading-shimmer"></div></div>
  </section>

  <!-- Inline Approval Queue -->
  <section id="inline-approval-section" style="display:none">
    <div class="section-header">
      <div class="section-title" style="display:flex;align-items:center;gap:8px">
        Pending Approval
        <span id="approval-count-badge" class="nav-badge" style="display:none">0</span>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn btn-sm" onclick="toggleApprovalCollapse()">Toggle</button>
      </div>
    </div>
    <div id="inline-approval-box"></div>
  </section>

  <!-- Live Triage Queue -->
  <section>
    <div class="section-header">
      <div class="section-title" style="display:flex;align-items:center;gap:8px">
        Live Triage Queue
        <span id="triage-new-badge" class="nav-badge" style="display:none">0</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <span id="triage-poll-status" style="font-size:0.68rem;color:var(--text-muted);font-family:var(--font-mono)">--</span>
        <button class="btn btn-sm" id="triage-config-btn" onclick="toggleTriageConfig()" title="Auto-approve settings" style="font-size:0.72rem;padding:3px 8px">&#9881;</button>
        <button class="btn btn-sm" onclick="loadTriageQueue()">Refresh</button>
      </div>
    </div>
    <div id="triage-filters" style="display:flex;gap:0;margin-bottom:12px;border:1px solid var(--border);border-radius:6px;overflow:hidden;width:fit-content">
      <button class="triage-filter active" data-filter="all" onclick="setTriageFilter('all',this)">All</button>
      <button class="triage-filter" data-filter="matched" onclick="setTriageFilter('matched',this)">Matched</button>
      <button class="triage-filter" data-filter="unmatched" onclick="setTriageFilter('unmatched',this)">No Match</button>
    </div>
    <div id="triage-queue-box"><div class="loading-shimmer" style="height:300px"></div></div>
  </section>

  <!-- Stats -->
  <section>
    <div class="section-header">
      <div class="section-title">Weekly Metrics</div>
      <button class="btn btn-sm" onclick="loadMetrics()">Refresh</button>
    </div>
    <div class="stats-grid" id="stats-box">
      <div class="loading-shimmer"></div><div class="loading-shimmer"></div>
      <div class="loading-shimmer"></div><div class="loading-shimmer"></div>
    </div>
  </section>

  <!-- Charts -->
  <section>
    <div class="section-header"><div class="section-title">Breakdown</div></div>
    <div class="charts-grid" id="charts-box">
      <div class="loading-shimmer" style="height:200px"></div>
      <div class="loading-shimmer" style="height:200px"></div>
    </div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script src="shared/utils.js"></script>
<script src="shared/sync.js"></script>
<script src="shared/keyboard.js"></script>
<script src="shared/nav.js"></script>
<script>
(function(){
'use strict';

var metricsData = null, incidentsData = null;
var triageQueueData = null;
var currentFilter = 'all';
var firstLoad = true;

// Persistent state via localStorage
function loadState(key, fallback) {
  try { return JSON.parse(localStorage.getItem(key)) || fallback; }
  catch(e) { return fallback; }
}
function saveState(key, val) {
  try { localStorage.setItem(key, JSON.stringify(val)); } catch(e) {}
}

var seenTicketIds = loadState('triage_seenIds', {});
var dismissedIds = loadState('triage_dismissedIds', {});
var handledIds = loadState('triage_handledIds', {});
var triageFeedback = loadState('triage_feedback', { patterns: {} });

// Batch selection state
var selectedIds = {};

// Triage config (auto-approve, etc.)
var triageConfig = loadState('triage_config', {
  autoApproveThreshold: 0,
  autoApproveWithReply: true,
});

// SLA thresholds (hours)
var SLA_HOURS = { urgent: 1, high: 4, normal: 8, low: 24 };

function getSLA(priority, createdAt) {
  var limit = SLA_HOURS[(priority || 'normal').toLowerCase()] || 8;
  var elapsed = (Date.now() - new Date(createdAt).getTime()) / 3600000;
  var remaining = limit - elapsed;
  var pct = (elapsed / limit) * 100;
  var label;
  if (remaining <= 0) label = 'BREACH';
  else if (remaining < 1) label = Math.round(remaining * 60) + 'm';
  else label = Math.floor(remaining) + 'h ' + Math.round((remaining % 1) * 60) + 'm';
  return {
    remaining: remaining,
    breached: remaining <= 0,
    cls: remaining <= 0 ? 'sla-breach' : pct >= 75 ? 'sla-warn' : 'sla-ok',
    label: label,
  };
}

// Prune entries older than 30 days on load
(function pruneOldFeedback() {
  var cutoff = Date.now() - 30 * 24 * 3600000;
  var patterns = triageFeedback.patterns;
  for (var key in patterns) {
    if (new Date(patterns[key].last).getTime() < cutoff) {
      delete patterns[key];
    }
  }
  saveState('triage_feedback', triageFeedback);
})();

function recordFeedback(action, errorPattern, problemId) {
  if (!errorPattern || errorPattern === 'other' || !problemId) return;
  var key = errorPattern + '::' + problemId;
  var entry = triageFeedback.patterns[key] || { approved: 0, dismissed: 0, last: '' };
  if (action === 'dismiss') entry.dismissed++;
  else if (action === 'approve') entry.approved++;
  entry.last = new Date().toISOString();
  triageFeedback.patterns[key] = entry;
  saveState('triage_feedback', triageFeedback);
}

function getFeedbackAdjustment(errorPattern, problemId) {
  if (!errorPattern || errorPattern === 'other' || !problemId) return 'neutral';
  var key = errorPattern + '::' + problemId;
  var entry = triageFeedback.patterns[key];
  if (!entry) return 'neutral';
  var total = entry.approved + entry.dismissed;
  if (total < 3) return 'neutral';
  if (entry.dismissed / total > 0.6) return 'suppress';
  if (entry.approved / total > 0.7) return 'boost';
  return 'neutral';
}

// ---- Incidents ----
window.loadIncidents = function(){
  CC.api('incidents').then(function(d){
    if(!d)return;
    incidentsData=d;
    renderIncidents(d);
    renderStatus(d);
  }).catch(function(e){ CC.toast('Incidents: '+e.message, false); });
};

function renderStatus(d){
  var el=document.getElementById('status-badge');
  var n=(d&&d.incidents)?d.incidents.length:0;
  var cls,txt;
  if(n===0){cls='status-green';txt='All Clear';}
  else if(n>=5){cls='status-red';txt=n+' Problems';}
  else{cls='status-yellow';txt=n+' Problem'+(n>1?'s':'');}
  el.innerHTML='<span class="status-badge '+cls+'"><span class="dot"></span>'+txt+'</span>';
}

function renderIncidents(d){
  var box=document.getElementById('incidents-box');
  if(!d||!d.incidents||d.incidents.length===0){
    box.innerHTML='<div class="all-clear fade-in"><div class="title">All Clear</div><div class="sub">No active problem tickets</div></div>';
    return;
  }
  var h='<div class="incidents-grid fade-in">';
  d.incidents.forEach(function(i){
    var age=CC.ageH(i.createdAt);
    var ac=age>24?'age-critical':age>4?'age-warning':'age-ok';
    var linked=i.linkedCount||0;
    var hasJira=i.jiraLinks&&i.jiraLinks.length>0;
    var pid=i.problemId;

    h+='<div class="incident-card '+ac+'">';
    h+='<div class="incident-header">';
    h+='<span class="incident-id"><a href="'+CC.ZD+pid+'" target="_blank">ZD#'+pid+'</a></span>';
    h+='<span class="age-pill '+ac+'">'+CC.relTime(i.createdAt)+'</span>';
    h+='</div>';
    h+='<div class="incident-subject">'+CC.esc(i.subject)+'</div>';
    h+='<div class="incident-meta">';
    if(hasJira){
      i.jiraLinks.forEach(function(j){
        h+='<span><span class="label">Jira:</span> <a href="'+CC.esc(j.url)+'" target="_blank"><strong>'+CC.esc(j.issueKey)+'</strong></a></span>';
      });
    }
    h+='<span><span class="label">Status:</span> <span class="value">'+CC.esc(i.status)+'</span></span>';
    h+='</div>';

    // Action buttons row
    if(i.linkedTickets&&i.linkedTickets.length>0){
      var lastUp=getLastUpdate(pid);
      h+='<div style="display:flex;gap:6px;align-items:center;margin-top:8px;flex-wrap:wrap">';
      h+='<button class="btn btn-sm" onclick="toggleLinked('+pid+',this)" style="font-size:0.7rem">'+linked+' Linked</button>';
      h+='<button class="btn btn-sm" onclick="toggleUpdatePanel('+pid+')" style="font-size:0.7rem;background:var(--bg-input);border:1px solid var(--border)">Send Update</button>';
      h+='<span id="last-update-'+pid+'" style="font-size:0.62rem;color:var(--text-muted);font-family:var(--font-mono)">'+(lastUp?CC.relTime(lastUp):'no updates')+'</span>';
      h+='</div>';

      // Send Update panel (hidden)
      h+='<div id="update-panel-'+pid+'" style="display:none;margin-top:10px;padding:12px;background:rgba(118,195,206,0.04);border:1px solid var(--border);border-radius:var(--radius)">';
      h+='<div style="font-size:0.68rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px">Bulk Update for ZD#'+pid+'</div>';
      h+='<textarea id="update-msg-'+pid+'" style="width:100%;min-height:70px;padding:8px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:var(--font-sub);font-size:0.8rem;resize:vertical;box-sizing:border-box" placeholder="Type update message..."></textarea>';
      h+='<div style="margin-top:8px;margin-bottom:8px">';
      h+='<label style="display:flex;align-items:center;gap:6px;font-size:0.72rem;font-weight:600;color:var(--text-secondary);cursor:pointer;margin-bottom:4px">';
      h+='<input type="checkbox" checked onchange="toggleAllChecks('+pid+',this.checked)" style="accent-color:var(--av-green)"> All '+i.linkedTickets.length+' tickets';
      h+='</label>';
      h+='<div id="update-checks-'+pid+'" style="display:flex;flex-direction:column;gap:2px;margin-left:4px">';
      i.linkedTickets.forEach(function(t){
        h+='<label style="display:flex;align-items:center;gap:6px;font-size:0.7rem;color:var(--text-secondary);cursor:pointer">';
        h+='<input type="checkbox" checked class="update-check-'+pid+'" value="'+t.id+'" onchange="updateSendCount('+pid+')" style="accent-color:var(--av-green)">';
        h+='#'+t.id+' <span style="color:var(--text-muted)">'+CC.esc(CC.trunc(t.subject,35))+'</span>';
        h+='</label>';
      });
      h+='</div></div>';
      h+='<div style="display:flex;gap:8px;align-items:center">';
      h+='<button class="btn btn-approve btn-sm" id="send-update-btn-'+pid+'" onclick="sendBulkUpdate('+pid+',this)">Send Update to '+i.linkedTickets.length+' tickets</button>';
      h+='<button class="btn btn-muted btn-sm" onclick="toggleUpdatePanel('+pid+')">Cancel</button>';
      h+='<span id="update-status-'+pid+'" style="font-size:0.68rem;color:var(--text-muted)"></span>';
      h+='</div></div>';

      // Linked tickets list (hidden)
      h+='<div id="linked-'+pid+'" style="display:none;margin-top:8px">';
      i.linkedTickets.forEach(function(t){
        h+='<div style="border:1px solid var(--border-subtle);border-radius:var(--radius);margin-bottom:6px;overflow:hidden">';
        h+='<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--bg-input);cursor:pointer;gap:8px" onclick="toggleTicketDetail('+t.id+')">';
        h+='<div style="display:flex;align-items:center;gap:8px;min-width:0">';
        h+='<a href="'+CC.ZD+t.id+'" target="_blank" onclick="event.stopPropagation()" style="font-family:var(--font-mono);font-weight:600;color:var(--av-blue);font-size:0.75rem;flex-shrink:0">#'+t.id+'</a>';
        h+='<span style="font-size:0.75rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">'+CC.esc(CC.trunc(t.subject,40))+'</span>';
        h+='</div>';
        h+='<div style="display:flex;gap:4px;flex-shrink:0">';
        if(hasJira) h+='<button class="btn btn-link btn-sm" onclick="event.stopPropagation();propagateJira('+t.id+','+pid+',this)" style="font-size:0.62rem;padding:2px 6px">Jira</button>';
        h+='</div></div>';
        h+='<div id="detail-'+t.id+'" style="display:none;padding:10px;border-top:1px solid var(--border-subtle)">';
        h+='<div id="detail-content-'+t.id+'" style="margin-bottom:10px"><div class="loading-shimmer" style="height:50px"></div></div>';
        h+='<div style="border-top:1px solid var(--border-subtle);padding-top:8px">';
        h+='<textarea id="comm-'+t.id+'" style="width:100%;min-height:60px;padding:6px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:var(--font-sub);font-size:0.78rem;resize:vertical;box-sizing:border-box" placeholder="Internal note..."></textarea>';
        h+='<div style="display:flex;gap:6px;margin-top:6px">';
        h+='<button class="btn btn-approve btn-sm" onclick="sendComment('+t.id+',this)" style="font-size:0.68rem">Send Note</button>';
        h+='<span id="comm-status-'+t.id+'" style="font-size:0.68rem;color:var(--text-muted);align-self:center"></span>';
        h+='</div></div></div>';
        h+='</div>';
      });
      h+='</div>';
    } else if(linked>0){
      h+='<div style="font-size:0.72rem;color:var(--text-muted);margin-top:8px">'+linked+' linked</div>';
    }

    h+='</div>';
  });
  h+='</div>';
  box.innerHTML=h;
}

// ---- Live Triage Queue ----
window.loadTriageQueue = function(){
  CC.api('triage-queue?hours=2').then(function(d){
    if(!d) return;

    // Count new tickets since last poll
    var newCount = 0;
    (d.queue || []).forEach(function(item){
      if(!seenTicketIds[item.ticketId]){
        seenTicketIds[item.ticketId] = true;
        if(!firstLoad) newCount++;
      }
    });

    triageQueueData = d;
    firstLoad = false;
    saveState('triage_seenIds', seenTicketIds);

    // Flash new badge
    var badge = document.getElementById('triage-new-badge');
    if(newCount > 0){
      badge.textContent = '+' + newCount;
      badge.style.display = 'inline-flex';
      setTimeout(function(){ badge.style.display = 'none'; }, 8000);
    }

    // Poll timestamp
    document.getElementById('triage-poll-status').textContent =
      d.count + ' tickets | ' + d.matchedCount + ' matched | polled ' + CC.fmtTime(d.generatedAt);

    renderTriageQueue(d);
  }).catch(function(e){ CC.toast('Triage: '+e.message, false); });
};

window.setTriageFilter = function(filter, btn){
  currentFilter = filter;
  var btns = document.querySelectorAll('.triage-filter');
  btns.forEach(function(b){
    if(b === btn){
      b.classList.add('active');
      b.style.background = 'var(--av-green-dark)';
      b.style.color = '#fff';
    } else {
      b.classList.remove('active');
      b.style.background = 'var(--bg-card)';
      b.style.color = 'var(--text-secondary)';
    }
  });
  if(triageQueueData) renderTriageQueue(triageQueueData);
};

function renderTriageQueue(d){
  var box = document.getElementById('triage-queue-box');
  var queue = (d && d.queue) ? d.queue : [];

  // Apply filter + remove dismissed/handled
  var filtered = queue.filter(function(item){
    if(dismissedIds[item.ticketId] || handledIds[item.ticketId]) return false;
    return true;
  });

  // Apply feedback-based learning adjustments
  filtered = filtered.map(function(item) {
    if (!item.match) return item;
    var adj = getFeedbackAdjustment(item.errorPattern, item.match.problemId);
    if (adj === 'suppress') {
      return Object.assign({}, item, { match: null, suggestedReply: null });
    }
    if (adj === 'boost' && item.match.confidence !== 'high') {
      var boosted = Object.assign({}, item.match);
      if (boosted.confidence === 'low') boosted.confidence = 'medium';
      else if (boosted.confidence === 'medium') boosted.confidence = 'high';
      boosted.matchReason = boosted.matchReason + ' (boosted by feedback)';
      return Object.assign({}, item, { match: boosted });
    }
    return item;
  });

  // Apply matched/unmatched filter
  if (currentFilter === 'matched') {
    filtered = filtered.filter(function(item) { return item.match !== null; });
  } else if (currentFilter === 'unmatched') {
    filtered = filtered.filter(function(item) { return item.match === null; });
  }

  // Auto-approve high confidence matches
  var autoCount = 0;
  if (triageConfig.autoApproveThreshold > 0) {
    filtered = filtered.filter(function(item) {
      if (item.match && item.match.score >= triageConfig.autoApproveThreshold) {
        autoApproveItem(item);
        autoCount++;
        return false; // remove from display
      }
      return true;
    });
    if (autoCount > 0) CC.toast('Auto-approved ' + autoCount + ' ticket' + (autoCount > 1 ? 's' : ''), true);
  }

  // Clear batch selection for items no longer in queue
  var validIds = {};
  filtered.forEach(function(item) { validIds[item.ticketId] = true; });
  for (var sid in selectedIds) { if (!validIds[sid]) delete selectedIds[sid]; }

  if(!filtered.length){
    box.innerHTML = '<div class="all-clear fade-in"><div class="title">Queue Clear</div>' +
      '<div class="sub">No unlinked tickets in the last 2 hours</div></div>';
    return;
  }

  // Sort: high confidence first, then medium, then unmatched, then by SLA urgency
  var confOrder = {high: 0, medium: 1, low: 2};
  filtered.sort(function(a, b){
    var ca = a.match ? (confOrder[a.match.confidence] != null ? confOrder[a.match.confidence] : 3) : 3;
    var cb = b.match ? (confOrder[b.match.confidence] != null ? confOrder[b.match.confidence] : 3) : 3;
    if(ca !== cb) return ca - cb;
    // Within same confidence, sort by SLA urgency
    var sa = getSLA(a.priority, a.createdAt).remaining;
    var sb = getSLA(b.priority, b.createdAt).remaining;
    return sa - sb;
  });

  // Batch action bar
  var selCount = Object.keys(selectedIds).length;
  var h = '';
  if (selCount > 0) {
    h += '<div class="batch-bar" id="batch-bar">';
    h += '<span class="count">' + selCount + ' selected</span>';
    h += '<button class="btn btn-approve btn-sm" onclick="batchApproveSelected()">Approve All</button>';
    h += '<button class="btn btn-muted btn-sm" onclick="batchDismissSelected()">Dismiss All</button>';
    h += '<button class="btn btn-sm" onclick="clearSelection()">Clear</button>';
    h += '</div>';
  }

  h += '<div class="triage-queue-grid fade-in">';

  filtered.forEach(function(item){
    var borderColor = item.match
      ? (item.match.confidence === 'high' ? 'var(--av-green)'
        : item.match.confidence === 'medium' ? 'var(--accent-yellow)'
        : 'var(--border)')
      : 'var(--border)';
    var pri = (item.priority || 'normal').toLowerCase();
    var sla = getSLA(item.priority, item.createdAt);
    var isSelected = !!selectedIds[item.ticketId];

    h += '<div class="triage-queue-card' + (isSelected ? ' kb-focused' : '') + '" id="tq-' + item.ticketId + '" style="border-left:4px solid ' + borderColor + '">';

    // Row 1: Checkbox + Ticket info + SLA + dismiss
    h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px">';
    h += '<div style="display:flex;align-items:center;gap:8px">';
    if (item.match) {
      h += '<input type="checkbox" class="batch-check" data-tid="' + item.ticketId + '"' + (isSelected ? ' checked' : '') + ' onclick="toggleSelect(' + item.ticketId + ',this.checked)" title="Select for batch action">';
    }
    h += '<a href="' + CC.ZD + item.ticketId + '" target="_blank" style="font-family:var(--font-mono);font-weight:700;color:var(--av-blue)">#' + item.ticketId + '</a>';
    h += ' <span class="priority-badge p-' + pri + '" style="margin-left:4px">' + CC.esc(pri) + '</span>';
    h += ' <span class="sla-badge ' + sla.cls + '">' + sla.label + '</span>';
    h += ' <span class="age-pill ' + (CC.ageH(item.createdAt) > 1 ? 'age-warning' : 'age-ok') + '">' + CC.relTime(item.createdAt) + '</span>';
    h += '</div>';
    h += '<button class="btn btn-muted btn-sm" onclick="dismissTriageItem(' + item.ticketId + ')" title="[D] Dismiss">Dismiss</button>';
    h += '</div>';

    // Subject
    h += '<div style="font-size:0.88rem;font-weight:500;margin-bottom:6px;color:var(--text-primary)">' + CC.esc(item.subject) + '</div>';

    // Badges: category, POS, error pattern
    h += '<div style="display:flex;gap:5px;flex-wrap:wrap;margin-bottom:10px">';
    if(item.category && item.category !== 'general'){
      h += '<span style="font-size:0.62rem;padding:2px 7px;border-radius:4px;background:rgba(118,195,206,0.12);color:var(--av-blue);font-weight:600;text-transform:uppercase">' + CC.esc(item.category) + '</span>';
    }
    if(item.pos){
      h += '<span style="font-size:0.62rem;padding:2px 7px;border-radius:4px;background:rgba(117,194,154,0.12);color:var(--av-green);font-weight:600">' + CC.esc(item.pos) + '</span>';
    }
    if(item.errorPattern && item.errorPattern !== 'other'){
      h += '<span style="font-size:0.62rem;padding:2px 7px;border-radius:4px;background:rgba(232,134,58,0.12);color:var(--accent-orange);font-weight:600">' + CC.esc(item.errorPattern) + '</span>';
    }
    h += '</div>';

    // Match recommendation
    if(item.match){
      var m = item.match;
      var confBg = m.confidence === 'high' ? 'rgba(117,194,154,0.08)' : 'rgba(240,192,80,0.08)';
      var confColor = m.confidence === 'high' ? 'var(--av-green)' : 'var(--accent-yellow)';

      h += '<div style="background:' + confBg + ';border:1px solid ' + confColor + ';border-radius:6px;padding:10px 14px;margin-bottom:10px">';
      h += '<div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;color:' + confColor + ';margin-bottom:4px;letter-spacing:0.04em">';
      h += CC.esc(m.confidence) + ' match (' + m.score + '%)';
      h += '</div>';
      h += '<div style="font-size:0.84rem;margin-bottom:4px">';
      h += 'Link to <a href="' + CC.ZD + m.problemId + '" target="_blank" style="font-weight:700">ZD#' + m.problemId + '</a>: ' + CC.esc(CC.trunc(m.problemSubject, 60));
      h += '</div>';
      if(m.jiraLinks && m.jiraLinks.length){
        m.jiraLinks.forEach(function(j){
          h += '<span style="font-size:0.72rem;color:var(--text-secondary)">Jira: <a href="' + CC.esc(j.url) + '" target="_blank" style="font-weight:700">' + CC.esc(j.issueKey) + '</a></span> ';
        });
      }
      h += '<div style="font-size:0.68rem;color:var(--text-muted);margin-top:4px">' + CC.esc(m.matchReason) + '</div>';
      h += '</div>';

      // Editable reply
      if(item.suggestedReply){
        h += '<div style="margin-bottom:10px">';
        h += '<label style="display:block;font-size:0.65rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px">Suggested Internal Note</label>';
        h += '<textarea id="reply-' + item.ticketId + '" style="width:100%;min-height:55px;padding:8px 12px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:var(--font-sub);font-size:0.8rem;resize:vertical;box-sizing:border-box">' + CC.esc(item.suggestedReply) + '</textarea>';
        h += '</div>';
      }

      // Action button
      h += '<button class="btn btn-approve" id="approve-btn-' + item.ticketId + '" onclick="approveAndLink(' + item.ticketId + ',' + m.problemId + ',this)">Approve &amp; Link</button>';

    } else {
      // No match
      h += '<div style="font-size:0.78rem;color:var(--text-muted);padding:6px 0;margin-bottom:6px">No matching Problem Ticket found</div>';
      if(incidentsData && incidentsData.incidents && incidentsData.incidents.length){
        h += '<button class="btn btn-link btn-sm" onclick="showLinkMenu(' + item.ticketId + ',this)">Link Manually</button>';
      }
    }

    h += '</div>';
  });

  h += '</div>';
  box.innerHTML = h;
}

// ---- One-click Approve & Link ----
window.approveAndLink = function(ticketId, problemId, btn){
  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Linking...';

  // Look up item for feedback learning
  var queueItem = null;
  if (triageQueueData && triageQueueData.queue) {
    queueItem = triageQueueData.queue.find(function(q) { return q.ticketId === ticketId; });
  }
  var errorPattern = queueItem ? queueItem.errorPattern : null;

  var replyEl = document.getElementById('reply-' + ticketId);
  var replyBody = replyEl ? replyEl.value.trim() : '';

  // Step 1: Link ticket to problem
  CC.api('link', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ ticketId: ticketId, problemId: problemId })
  }).then(function(linkResult){
    if(!linkResult || !linkResult.success) throw new Error('Link failed');

    // Step 2: Post internal note if reply text exists
    if(replyBody){
      return CC.api('comment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
          ticketId: ticketId,
          body: replyBody
        })
      });
    }
    return { success: true };
  }).then(function(){
    handledIds[ticketId] = true;
    saveState('triage_handledIds', handledIds);

    // Record feedback locally + persist to Zendesk
    recordFeedback('approve', errorPattern, problemId);
    CC.api('feedback', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        ticketId: ticketId,
        action: 'approve',
        errorPattern: errorPattern,
        problemId: problemId
      })
    }).catch(function() {});

    var card = document.getElementById('tq-' + ticketId);
    if(card){
      card.style.borderLeftColor = 'var(--av-green)';
      card.style.opacity = '0.5';
      card.innerHTML = '<div style="padding:10px;display:flex;align-items:center;gap:8px">' +
        '<span style="color:var(--av-green);font-weight:700;font-size:0.85rem">Linked #' + ticketId + ' to ZD#' + problemId + (replyBody ? ' + note posted' : '') + '</span></div>';
    }
    CC.toast('Linked #' + ticketId + ' to Problem #' + problemId, true);
    CC.sync.emit('triage-handled', { ticketId: ticketId, problemId: problemId });
  }).catch(function(e){
    CC.toast('Error: ' + e.message, false);
    btn.classList.remove('loading');
    btn.innerHTML = 'Approve &amp; Link';
  });
};

// ---- Dismiss ----
window.dismissTriageItem = function(ticketId){
  dismissedIds[ticketId] = true;
  saveState('triage_dismissedIds', dismissedIds);

  // Look up item for feedback learning
  var item = null;
  if (triageQueueData && triageQueueData.queue) {
    item = triageQueueData.queue.find(function(q) { return q.ticketId === ticketId; });
  }

  // Record feedback locally if there was a match
  if (item && item.match) {
    recordFeedback('dismiss', item.errorPattern, item.match.problemId);
  }

  // Persist to Zendesk (fire-and-forget)
  CC.api('feedback', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({
      ticketId: ticketId,
      action: 'dismiss'
    })
  }).catch(function() {});

  var card = document.getElementById('tq-' + ticketId);
  if(card) card.remove();
  CC.sync.emit('triage-dismissed', { ticketId: ticketId });
};

// ---- Auto-Approve (fires silently for high confidence) ----
function autoApproveItem(item) {
  if (!item.match) return;
  var ticketId = item.ticketId;
  var problemId = item.match.problemId;
  var replyBody = (triageConfig.autoApproveWithReply && item.suggestedReply) ? item.suggestedReply : '';

  handledIds[ticketId] = { auto: true, at: new Date().toISOString() };
  saveState('triage_handledIds', handledIds);

  // Link
  CC.api('link', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ ticketId: ticketId, problemId: problemId })
  }).then(function(d) {
    if (!d || !d.success) return;
    // Post reply if configured
    if (replyBody) {
      CC.api('comment', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ ticketId: ticketId, body: replyBody })
      }).catch(function() {});
    }
    recordFeedback('approve', item.errorPattern, problemId);
    CC.sync.emit('triage-handled', { ticketId: ticketId, problemId: problemId, auto: true });
  }).catch(function() {});
}

// ---- Batch Selection ----
window.toggleSelect = function(ticketId, checked) {
  if (checked) selectedIds[ticketId] = true;
  else delete selectedIds[ticketId];
  updateBatchBar();
};

window.clearSelection = function() {
  selectedIds = {};
  document.querySelectorAll('.batch-check').forEach(function(cb) { cb.checked = false; });
  updateBatchBar();
};

function updateBatchBar() {
  var count = Object.keys(selectedIds).length;
  var bar = document.getElementById('batch-bar');
  if (count === 0 && bar) bar.remove();
  else if (count > 0 && bar) {
    bar.querySelector('.count').textContent = count + ' selected';
  } else if (count > 0 && !bar) {
    // Re-render triage queue to show bar
    if (triageQueueData) renderTriageQueue(triageQueueData);
  }
}

window.batchApproveSelected = function() {
  var ids = Object.keys(selectedIds).map(Number);
  if (!ids.length) return;
  var queue = (triageQueueData && triageQueueData.queue) ? triageQueueData.queue : [];
  var items = [];
  ids.forEach(function(tid) {
    var item = queue.find(function(q) { return q.ticketId === tid; });
    if (item && item.match) {
      var replyEl = document.getElementById('reply-' + tid);
      items.push({ ticketId: tid, problemId: item.match.problemId, replyBody: replyEl ? replyEl.value.trim() : '' });
    }
  });
  if (!items.length) { CC.toast('No matched items in selection', false); return; }

  CC.toast('Batch linking ' + items.length + ' tickets...', true);

  // Use batch-link API for single-call processing
  CC.api('batch-link', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ items: items }),
  }).then(function(d) {
    if (d && d.success) {
      d.results.forEach(function(r) {
        if (r.success) {
          handledIds[r.ticketId] = true;
          CC.sync.emit('triage-handled', { ticketId: r.ticketId, problemId: r.problemId });
          var card = document.getElementById('tq-' + r.ticketId);
          if (card) { card.style.opacity = '0.4'; card.style.borderLeftColor = 'var(--av-green)'; }
        }
      });
      saveState('triage_handledIds', handledIds);
      selectedIds = {};
      var msg = 'Batch complete: ' + d.succeeded + ' linked';
      if (d.failed > 0) msg += ', ' + d.failed + ' failed';
      CC.toast(msg, true);
      setTimeout(function() { if (triageQueueData) renderTriageQueue(triageQueueData); }, 1500);
    }
  }).catch(function(e) {
    CC.toast('Batch error: ' + e.message, false);
  });
};

window.batchDismissSelected = function() {
  var ids = Object.keys(selectedIds).map(Number);
  ids.forEach(function(tid) { dismissTriageItem(tid); });
  selectedIds = {};
};

// ---- Triage Config (auto-approve settings) ----
window.toggleTriageConfig = function() {
  var existing = document.getElementById('triage-config-popover');
  if (existing) { existing.remove(); return; }

  var btn = document.getElementById('triage-config-btn');
  var pop = document.createElement('div');
  pop.id = 'triage-config-popover';
  pop.className = 'config-popover';

  var thresholds = [0, 80, 90];
  var labels = ['OFF', '80+', '90+'];
  var h = '<label>Auto-approve threshold</label>';
  h += '<div class="config-btn-group">';
  thresholds.forEach(function(t, i) {
    h += '<button onclick="setAutoApprove(' + t + ')" class="' + (triageConfig.autoApproveThreshold === t ? 'active' : '') + '">' + labels[i] + '</button>';
  });
  h += '</div>';
  h += '<div style="font-size:0.65rem;color:var(--text-muted);margin-top:8px">Tickets above threshold are auto-linked on load</div>';
  pop.innerHTML = h;

  btn.parentNode.style.position = 'relative';
  btn.parentNode.appendChild(pop);

  // Close on outside click
  setTimeout(function() {
    document.addEventListener('click', function closeConfig(e) {
      if (!pop.contains(e.target) && e.target !== btn) {
        pop.remove();
        document.removeEventListener('click', closeConfig);
      }
    });
  }, 10);
};

window.setAutoApprove = function(threshold) {
  triageConfig.autoApproveThreshold = threshold;
  saveState('triage_config', triageConfig);
  var pop = document.getElementById('triage-config-popover');
  if (pop) pop.remove();
  CC.toast('Auto-approve: ' + (threshold === 0 ? 'OFF' : threshold + '+'), true);
};

// ---- Manual link (reused from old triage) ----
window.showLinkMenu = function(ticketId, btn){
  var incidents = incidentsData ? incidentsData.incidents : [];
  if(!incidents.length){ CC.toast('No active incidents', false); return; }
  var menu='<select onchange="linkTicket('+ticketId+',this.value,this)" style="font-size:0.7rem;padding:2px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);border-radius:4px">';
  menu+='<option value="">Pick problem...</option>';
  incidents.forEach(function(i){
    var jira=i.jiraLinks&&i.jiraLinks.length?'('+i.jiraLinks[0].issueKey+')':'';
    menu+='<option value="'+i.problemId+'">ZD#'+i.problemId+' '+jira+' '+CC.esc(CC.trunc(i.subject,30))+'</option>';
  });
  menu+='</select>';
  btn.outerHTML=menu;
};

window.linkTicket = function(ticketId, problemId, sel){
  if(!problemId)return;
  sel.disabled=true;
  CC.api('link',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, problemId:parseInt(problemId,10)})
  }).then(function(d){
    if(d&&d.success){
      handledIds[ticketId] = true;
      saveState('triage_handledIds', handledIds);
      var jira=d.jiraLinks&&d.jiraLinks.length?' + '+d.jiraLinks[0].issueKey:'';
      CC.toast('Linked #'+ticketId+' to Problem #'+problemId+jira, true);
      sel.outerHTML='<span style="color:var(--av-green);font-size:0.7rem;font-weight:600">Linked</span>';
    } else { CC.toast('Link failed', false); sel.disabled=false; }
  }).catch(function(e){ CC.toast(e.message, false); sel.disabled=false; });
};

// ---- Metrics ----
window.loadMetrics = function(){
  CC.api('metrics').then(function(d){
    if(!d)return;
    metricsData=d;
    renderStats(d);
    renderCharts(d);
    document.getElementById('header-sub').textContent=
      d.byDay&&d.byDay.length?d.byDay[0].day+' to '+d.byDay[d.byDay.length-1].day:'Current week';
    document.getElementById('last-updated').textContent='Updated '+CC.fmtTime(d.generatedAt);
  }).catch(function(e){ CC.toast('Metrics: '+e.message, false); });
};

function renderStats(d){
  var box=document.getElementById('stats-box');
  var tq = triageQueueData;
  var cards=[
    {l:'Tickets This Week',v:CC.fmt(d.totalTickets),det:'Resolved: '+CC.fmt(d.resolvedTickets)},
    {l:'Avg Per Day',v:d.avgPerDay?d.avgPerDay.toFixed(1):'--',det:'Period average'},
    {l:'Open Backlog',v:CC.fmt(d.openBacklog),det:'Unresolved tickets'},
    {l:'Queue Match Rate',v:tq?Math.round((tq.matchedCount/Math.max(tq.count,1))*100)+'%':'--',det:tq?tq.matchedCount+'/'+tq.count+' matched':''},
  ];
  var h='';
  cards.forEach(function(c){
    h+='<div class="stat-card fade-in"><div class="stat-label">'+CC.esc(c.l)+'</div><div class="stat-value">'+c.v+'</div><div class="stat-detail">'+CC.esc(c.det)+'</div></div>';
  });
  box.innerHTML=h;
}

function renderCharts(d){
  var box=document.getElementById('charts-box');
  var h='';
  h+='<div class="chart-card fade-in"><div class="chart-title">Tickets by Day</div>';
  if(d.byDay&&d.byDay.length){
    var mx=Math.max.apply(null,d.byDay.map(function(x){return x.count;}));
    h+='<div class="bar-chart-v">';
    d.byDay.forEach(function(x){
      var pct=mx>0?(x.count/mx)*100:0;
      h+='<div class="bar-col"><div class="bar-val">'+x.count+'</div><div class="bar-fill" style="height:'+pct+'%"></div><div class="bar-lbl">'+CC.esc(CC.dayLbl(x.day))+'</div></div>';
    });
    h+='</div>';
  } else h+='<div class="no-data">No data</div>';
  h+='</div>';
  h+=CC.hBar('By Category',d.byCategory);
  h+=CC.hBar('By POS',d.byPOS);
  box.innerHTML=h;
}

// ---- Get Last Update time from localStorage ----
function getLastUpdate(pid){
  try { return localStorage.getItem('pt_lastUpdate_'+pid) || ''; }
  catch(e){ return ''; }
}

// ---- Toggle Send Update Panel ----
window.toggleUpdatePanel = function(pid){
  var el=document.getElementById('update-panel-'+pid);
  if(!el)return;
  el.style.display=el.style.display==='none'?'block':'none';
};

// ---- Toggle All Checkboxes ----
window.toggleAllChecks = function(pid, checked){
  var boxes=document.querySelectorAll('.update-check-'+pid);
  boxes.forEach(function(b){ b.checked=checked; });
  updateSendCount(pid);
};

// ---- Update Send Button Count ----
window.updateSendCount = function(pid){
  var boxes=document.querySelectorAll('.update-check-'+pid+':checked');
  var btn=document.getElementById('send-update-btn-'+pid);
  if(btn) btn.textContent='Send Update to '+boxes.length+' ticket'+(boxes.length!==1?'s':'');
};

// ---- Send Bulk Update ----
window.sendBulkUpdate = function(pid, btn){
  var msgEl=document.getElementById('update-msg-'+pid);
  var statusEl=document.getElementById('update-status-'+pid);
  var message=(msgEl?msgEl.value:'').trim();
  if(!message){ CC.toast('Type a message first',false); return; }

  var boxes=document.querySelectorAll('.update-check-'+pid+':checked');
  var ticketIds=[];
  boxes.forEach(function(b){ ticketIds.push(parseInt(b.value,10)); });
  if(!ticketIds.length){ CC.toast('Select at least one ticket',false); return; }

  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span> Sending...';
  statusEl.textContent='';

  CC.api('bulk-update',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ problemId:pid, ticketIds:ticketIds, message:message })
  }).then(function(d){
    if(d&&d.success){
      // Save last update time
      var now=new Date().toISOString();
      try{ localStorage.setItem('pt_lastUpdate_'+pid, now); }catch(e){}

      // Update timer display
      var timerEl=document.getElementById('last-update-'+pid);
      if(timerEl) timerEl.textContent='just now';

      // Collapse panel
      var panel=document.getElementById('update-panel-'+pid);
      if(panel) panel.style.display='none';

      // Clear textarea
      if(msgEl) msgEl.value='';

      btn.classList.remove('loading');
      btn.textContent='Send Update to '+ticketIds.length+' ticket'+(ticketIds.length!==1?'s':'');

      var msg='Update sent to '+d.updatedCount+' ticket'+(d.updatedCount!==1?'s':'')+' on ZD#'+pid;
      if(d.failedCount>0) msg+=' ('+d.failedCount+' failed)';
      CC.toast(msg, true);
    } else {
      throw new Error('Unexpected response');
    }
  }).catch(function(e){
    CC.toast('Error: '+e.message, false);
    btn.classList.remove('loading');
    btn.textContent='Send Update';
    statusEl.textContent='Failed: '+e.message;
    statusEl.style.color='var(--accent-red)';
  });
};

// ---- Toggle Linked Tickets ----
window.toggleLinked = function(problemId, btn){
  var el=document.getElementById('linked-'+problemId);
  if(!el)return;
  if(el.style.display==='none'){
    el.style.display='block';
    btn.style.background='var(--av-green-dark)';
    btn.style.color='#fff';
  } else {
    el.style.display='none';
    btn.style.background='';
    btn.style.color='';
  }
};

// ---- Toggle Individual Ticket Detail ----
window.toggleTicketDetail = function(ticketId){
  var el=document.getElementById('detail-'+ticketId);
  if(!el)return;
  if(el.style.display==='none'){
    el.style.display='block';
    loadTicketDetail(ticketId);
  } else {
    el.style.display='none';
  }
};

// ---- Load Ticket Detail (latest comments) ----
function loadTicketDetail(ticketId){
  var box=document.getElementById('detail-content-'+ticketId);
  box.innerHTML='<div class="loading-shimmer" style="height:60px"></div>';
  CC.api('ticket-detail?id='+ticketId).then(function(d){
    if(!d||!d.ticket){box.innerHTML='<div style="color:var(--text-muted);font-size:0.82rem">Failed to load</div>';return;}
    var t=d.ticket;
    var h='<div style="display:flex;gap:16px;flex-wrap:wrap;font-size:0.78rem;color:var(--text-secondary);margin-bottom:10px">';
    h+='<span><strong>Status:</strong> '+CC.esc(t.status)+'</span>';
    h+='<span><strong>Priority:</strong> '+CC.esc(t.priority||'normal')+'</span>';
    h+='<span><strong>Type:</strong> '+CC.esc(t.type||'ticket')+'</span>';
    h+='<span><strong>Updated:</strong> '+CC.relTime(t.updatedAt)+'</span>';
    h+='</div>';
    if(d.comments&&d.comments.length>0){
      h+='<div style="font-size:0.68rem;font-weight:700;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px">Recent Comments (newest first)</div>';
      h+='<div style="max-height:250px;overflow-y:auto">';
      d.comments.slice(0,8).forEach(function(c){
        var badge=c.public?'<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(118,195,206,0.15);color:var(--av-blue);margin-left:6px">PUBLIC</span>':'<span style="font-size:0.6rem;padding:1px 5px;border-radius:3px;background:rgba(117,194,154,0.15);color:var(--av-green);margin-left:6px">INTERNAL</span>';
        h+='<div style="border-left:2px solid '+(c.public?'var(--av-blue)':'var(--av-green)')+';padding:6px 10px;margin-bottom:6px;font-size:0.78rem;background:var(--bg-input);border-radius:0 4px 4px 0">';
        h+='<div style="font-size:0.68rem;color:var(--text-muted);margin-bottom:3px">'+CC.relTime(c.createdAt)+badge+'</div>';
        h+='<div style="white-space:pre-wrap;color:var(--text-secondary);max-height:100px;overflow-y:auto">'+CC.esc(CC.trunc(c.body,500))+'</div>';
        h+='</div>';
      });
      h+='</div>';
    } else {
      h+='<div style="color:var(--text-muted);font-size:0.82rem">No comments</div>';
    }
    box.innerHTML=h;
  }).catch(function(e){
    box.innerHTML='<div style="color:var(--accent-red);font-size:0.82rem">Error: '+CC.esc(e.message)+'</div>';
  });
}

// ---- Send Recommended Communication ----
window.sendComment = function(ticketId, btn){
  var textarea=document.getElementById('comm-'+ticketId);
  var status=document.getElementById('comm-status-'+ticketId);
  var body=textarea.value.trim();
  if(!body){CC.toast('Type a message first',false);return;}

  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span> Sending...';
  CC.api('comment',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, body:'--- Recommended Communication ---\n\n'+body+'\n\n-- TS Dashboard'})
  }).then(function(d){
    if(d&&d.success){
      CC.toast('Internal note added to #'+ticketId, true);
      btn.classList.remove('loading');
      btn.textContent='Send as Internal Note';
      textarea.value='';
      status.textContent='Sent '+CC.fmtTime(new Date().toISOString());
      status.style.color='var(--av-green)';
      loadTicketDetail(ticketId);
    } else {
      CC.toast('Failed to send', false);
      btn.classList.remove('loading');
      btn.textContent='Send as Internal Note';
    }
  }).catch(function(e){
    CC.toast(e.message, false);
    btn.classList.remove('loading');
    btn.textContent='Send as Internal Note';
  });
};

// ---- Propagate Jira to Linked Ticket ----
window.propagateJira = function(ticketId, problemId, btn){
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span>';
  CC.api('propagate-jira',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, problemId:problemId})
  }).then(function(d){
    if(d&&d.success){
      var jira=d.jiraLinks&&d.jiraLinks.length?d.jiraLinks[0].issueKey:'';
      CC.toast('Jira '+jira+' added to #'+ticketId, true);
      btn.outerHTML='<span style="color:var(--av-green);font-size:0.7rem;font-weight:600">Done</span>';
    } else {
      CC.toast('Failed to propagate Jira', false);
      btn.classList.remove('loading');
      btn.textContent='Add Jira';
    }
  }).catch(function(e){
    CC.toast(e.message, false);
    btn.classList.remove('loading');
    btn.textContent='Add Jira';
  });
};

// ---- Refresh All ----
window.refreshAll = function(){
  var btn=document.getElementById('refresh-btn');
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span> Refreshing...';
  Promise.all([
    CC.api('incidents').then(function(d){ if(d){incidentsData=d;renderIncidents(d);renderStatus(d);} }),
    CC.api('metrics').then(function(d){ if(d){metricsData=d;renderStats(d);renderCharts(d);document.getElementById('last-updated').textContent='Updated '+CC.fmtTime(d.generatedAt);} }),
    CC.api('triage-queue?hours=2').then(function(d){ if(d){triageQueueData=d;renderTriageQueue(d);} }),
  ]).then(function(){
    btn.classList.remove('loading');
    btn.textContent='Refresh All';
    CC.toast('All data refreshed', true);
  }).catch(function(){
    btn.classList.remove('loading');
    btn.textContent='Refresh All';
  });
};

// ---- Inline Approval Queue ----
var approvalCollapsed = loadState('approval_collapsed', false);

function getApprovalQueue() {
  return JSON.parse(localStorage.getItem('approvalQueue') || '[]');
}

function saveApprovalQueue(queue) {
  localStorage.setItem('approvalQueue', JSON.stringify(queue));
  if (typeof updateApprovalBadge === 'function') updateApprovalBadge();
}

window.renderInlineApproval = function() {
  var queue = getApprovalQueue();
  var section = document.getElementById('inline-approval-section');
  var box = document.getElementById('inline-approval-box');
  var badge = document.getElementById('approval-count-badge');

  if (queue.length === 0) {
    section.style.display = 'none';
    return;
  }

  section.style.display = '';
  badge.textContent = queue.length;
  badge.style.display = 'inline-flex';

  if (approvalCollapsed) {
    box.innerHTML = '<div style="padding:12px;font-size:0.82rem;color:var(--text-muted);cursor:pointer" onclick="toggleApprovalCollapse()">' +
      queue.length + ' item' + (queue.length !== 1 ? 's' : '') + ' waiting â€” click to expand</div>';
    return;
  }

  var h = '<div class="fade-in" style="display:flex;flex-direction:column;gap:10px">';
  queue.forEach(function(item, idx) {
    h += '<div class="approval-card" id="ia-card-' + idx + '" style="padding:14px 18px">';
    h += '<div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px">';
    h += '<div>';
    h += '<div style="font-size:0.92rem;font-weight:700;color:var(--text-primary)">' + CC.esc(item.pattern) + '</div>';
    h += '<div style="font-size:0.72rem;color:var(--text-muted);margin-top:2px">' + (item.ticketCount || 0) + ' tickets';
    if (item.orgCount) h += ' across ' + item.orgCount + ' orgs';
    h += ' &middot; ' + CC.relTime(item.addedAt) + '</div>';
    h += '</div>';
    h += '<button class="btn btn-muted btn-sm" onclick="dismissApprovalItem(' + idx + ')" style="font-size:0.68rem">Dismiss</button>';
    h += '</div>';

    // Ticket chips
    if (item.ticketIds && item.ticketIds.length) {
      h += '<div style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px">';
      item.ticketIds.slice(0, 8).forEach(function(tid) {
        h += '<a href="' + CC.ZD + tid + '" target="_blank" style="font-size:0.68rem;font-family:var(--font-mono);padding:1px 6px;background:var(--bg-input);border:1px solid var(--border);border-radius:4px;color:var(--av-blue)">#' + tid + '</a>';
      });
      if (item.ticketIds.length > 8) h += '<span style="font-size:0.68rem;color:var(--text-muted)">+' + (item.ticketIds.length - 8) + ' more</span>';
      h += '</div>';
    }

    // Compact form
    h += '<div style="display:flex;gap:8px;align-items:flex-end">';
    h += '<div style="flex:1">';
    h += '<input type="text" id="ia-subj-' + idx + '" value="' + CC.esc(item.suggestedSubject || '') + '" placeholder="Subject" style="width:100%;padding:5px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-size:0.82rem;box-sizing:border-box;margin-bottom:4px">';
    h += '<textarea id="ia-desc-' + idx + '" placeholder="Description" style="width:100%;min-height:40px;padding:5px 10px;background:var(--bg-input);border:1px solid var(--border);border-radius:6px;color:var(--text-primary);font-family:var(--font-sub);font-size:0.78rem;resize:vertical;box-sizing:border-box">' + CC.esc(item.suggestedDescription || '') + '</textarea>';
    h += '</div>';
    h += '<button class="btn btn-approve" onclick="inlineApproveItem(' + idx + ',this)" id="ia-approve-' + idx + '" style="white-space:nowrap">Create PT</button>';
    h += '</div>';

    h += '<div id="ia-result-' + idx + '"></div>';
    h += '</div>';
  });
  h += '</div>';
  box.innerHTML = h;
};

window.toggleApprovalCollapse = function() {
  approvalCollapsed = !approvalCollapsed;
  saveState('approval_collapsed', approvalCollapsed);
  renderInlineApproval();
};

window.inlineApproveItem = function(idx, btn) {
  var queue = getApprovalQueue();
  var item = queue[idx];
  if (!item) return;

  var subject = document.getElementById('ia-subj-' + idx).value.trim();
  var description = document.getElementById('ia-desc-' + idx).value.trim();
  if (!subject) { CC.toast('Subject is required', false); return; }

  btn.classList.add('loading');
  btn.innerHTML = '<span class="spinner"></span> Creating...';

  CC.api('create-problem', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      subject: subject,
      description: description,
      ticketIds: item.ticketIds || [],
      pattern: item.pattern,
    }),
  }).then(function(d) {
    if (d && d.success) {
      var problemId = d.problemId || d.ticketId || '?';
      var card = document.getElementById('ia-card-' + idx);
      card.style.borderLeftColor = 'var(--av-green)';
      card.style.opacity = '0.7';
      card.innerHTML = '<div style="display:flex;align-items:center;gap:8px;padding:6px">' +
        '<span style="color:var(--av-green);font-weight:700;font-size:0.85rem">Problem <a href="' + CC.ZD + problemId + '" target="_blank" style="color:var(--av-green)">ZD#' + problemId + '</a> Created</span></div>';

      queue.splice(idx, 1);
      saveApprovalQueue(queue);
      CC.sync.emit('approval-updated', {});
      CC.toast('Problem ticket #' + problemId + ' created', true);
      setTimeout(function() { renderInlineApproval(); loadIncidents(); }, 5000);
    } else {
      CC.toast('Failed to create problem ticket', false);
      btn.classList.remove('loading');
      btn.innerHTML = 'Create PT';
    }
  }).catch(function(e) {
    CC.toast(e.message, false);
    btn.classList.remove('loading');
    btn.innerHTML = 'Create PT';
  });
};

window.dismissApprovalItem = function(idx) {
  var queue = getApprovalQueue();
  if (idx < 0 || idx >= queue.length) return;
  queue.splice(idx, 1);
  saveApprovalQueue(queue);
  CC.sync.emit('approval-updated', {});
  CC.toast('Dismissed from approval queue', true);
  renderInlineApproval();
};

// ---- Cross-Tab Sync ----
CC.sync.on('triage-handled', function(d) {
  handledIds[d.ticketId] = true;
  saveState('triage_handledIds', handledIds);
  delete selectedIds[d.ticketId];
  var card = document.getElementById('tq-' + d.ticketId);
  if (card) {
    card.style.opacity = '0.4';
    card.style.borderLeftColor = 'var(--av-green)';
    card.innerHTML = '<div style="padding:10px"><span style="color:var(--av-green);font-weight:700;font-size:0.82rem">' +
      (d.auto ? 'Auto-linked' : 'Linked') + ' #' + d.ticketId + ' to ZD#' + d.problemId + ' (other tab)</span></div>';
  }
});

CC.sync.on('triage-dismissed', function(d) {
  dismissedIds[d.ticketId] = true;
  saveState('triage_dismissedIds', dismissedIds);
  var card = document.getElementById('tq-' + d.ticketId);
  if (card) card.remove();
});

CC.sync.on('approval-updated', function() {
  renderInlineApproval();
});

// ---- Smart Polling (visibility-aware) ----
function smartPoll(name, fn, intervalMs) {
  function tick() {
    if (document.hidden) {
      setTimeout(tick, intervalMs);
      return;
    }
    fn();
    setTimeout(tick, intervalMs);
  }
  setTimeout(tick, intervalMs);
}

// Immediate refresh when tab becomes visible
document.addEventListener('visibilitychange', function() {
  if (!document.hidden) {
    loadTriageQueue();
  }
});

// ---- Keyboard Shortcuts ----
CC.keyboard.register('j', 'Focus next triage item', function() { CC.keyboard.moveFocus(1); }, 'Triage');
CC.keyboard.register('k', 'Focus previous triage item', function() { CC.keyboard.moveFocus(-1); }, 'Triage');

CC.keyboard.register('a', 'Approve & Link focused item', function() {
  var tid = CC.keyboard.getFocusedTicketId();
  if (!tid) return;
  var btn = document.getElementById('approve-btn-' + tid);
  if (btn && !btn.disabled) btn.click();
}, 'Triage');

CC.keyboard.register('enter', 'Approve & Link focused item', function() {
  var tid = CC.keyboard.getFocusedTicketId();
  if (!tid) return;
  var btn = document.getElementById('approve-btn-' + tid);
  if (btn && !btn.disabled) btn.click();
}, 'Triage');

CC.keyboard.register('d', 'Dismiss focused item', function() {
  var tid = CC.keyboard.getFocusedTicketId();
  if (tid) dismissTriageItem(tid);
}, 'Triage');

CC.keyboard.register('e', 'Edit reply on focused item', function() {
  var tid = CC.keyboard.getFocusedTicketId();
  if (!tid) return;
  var textarea = document.getElementById('reply-' + tid);
  if (textarea) textarea.focus();
}, 'Triage');

CC.keyboard.register('x', 'Toggle select on focused item', function() {
  var tid = CC.keyboard.getFocusedTicketId();
  if (!tid) return;
  var cb = document.querySelector('#tq-' + tid + ' .batch-check');
  if (cb) { cb.checked = !cb.checked; toggleSelect(tid, cb.checked); }
}, 'Triage');

CC.keyboard.register('r', 'Refresh all data', function() { refreshAll(); }, 'General');
CC.keyboard.register('?', 'Show keyboard shortcuts', function() { CC.keyboard.showHelp(); }, 'General');
CC.keyboard.register('escape', 'Clear focus / close panels', function() {
  CC.keyboard.clearFocus();
  CC.keyboard.hideHelp();
  var pop = document.getElementById('triage-config-popover');
  if (pop) pop.remove();
}, 'General');

// Nav shortcuts: 1-6 for tabs
var navLinks = document.querySelectorAll('.nav-link');
for (var ni = 0; ni < Math.min(navLinks.length, 6); ni++) {
  (function(idx, link) {
    CC.keyboard.register(String(idx + 1), link.textContent.trim(), function() { window.location.href = link.href; }, 'Navigation');
  })(ni, navLinks[ni]);
}

CC.keyboard.register('ctrl+a', 'Select all matched triage items', function() {
  document.querySelectorAll('.batch-check').forEach(function(cb) {
    cb.checked = true;
    selectedIds[cb.dataset.tid] = true;
  });
  updateBatchBar();
}, 'Triage');

// ---- Init ----
loadIncidents();
loadMetrics();
loadTriageQueue();
renderInlineApproval();

// Re-render approval queue when localStorage changes from another tab (approval.html)
window.addEventListener('storage', function(e) {
  if (e.key === 'approvalQueue') renderInlineApproval();
});

// Smart polling: triage every 30s, everything else every 5 min (skips background tabs)
smartPoll('triage', loadTriageQueue, 30 * 1000);
smartPoll('incidents', loadIncidents, 5 * 60 * 1000);
smartPoll('metrics', loadMetrics, 5 * 60 * 1000);

})();
</script>
</body>
</html>
