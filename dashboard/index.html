<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AutoVitals Tech Support Command Center</title>
<link rel="icon" href="assets/av-icon-green.png" type="image/png">
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&family=Raleway:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="shared/styles.css">
</head>
<body>

<header class="header">
  <div class="header-left">
    <img src="assets/av-logo-white.png" alt="AutoVitals" class="header-logo">
    <div class="header-divider"></div>
    <div>
      <div class="header-title">Tech Support Command Center</div>
      <div class="header-subtitle" id="header-sub">Loading...</div>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge"></div>
    <button class="btn btn-primary" onclick="refreshAll()" id="refresh-btn">Refresh All</button>
    <div class="last-updated" id="last-updated">--</div>
  </div>
</header>

<div class="dashboard">
  <!-- Active Incidents -->
  <section class="incidents-section">
    <div class="section-header">
      <div class="section-title">Active Problem Tickets</div>
      <button class="btn btn-sm" onclick="loadIncidents()">Refresh</button>
    </div>
    <div id="incidents-box"><div class="loading-shimmer"></div></div>
  </section>

  <!-- Stats -->
  <section>
    <div class="section-header">
      <div class="section-title">Weekly Metrics</div>
      <button class="btn btn-sm" onclick="loadMetrics()">Refresh</button>
    </div>
    <div class="stats-grid" id="stats-box">
      <div class="loading-shimmer"></div><div class="loading-shimmer"></div>
      <div class="loading-shimmer"></div><div class="loading-shimmer"></div>
    </div>
  </section>

  <!-- Charts -->
  <section>
    <div class="section-header"><div class="section-title">Breakdown</div></div>
    <div class="charts-grid" id="charts-box">
      <div class="loading-shimmer" style="height:200px"></div>
      <div class="loading-shimmer" style="height:200px"></div>
    </div>
  </section>

  <!-- Triage -->
  <section>
    <div class="section-header">
      <div class="section-title">Ticket Triage (Last 24h)</div>
      <button class="btn btn-sm" onclick="loadTriage()">Refresh</button>
    </div>
    <div id="triage-box"><div class="loading-shimmer" style="height:300px"></div></div>
  </section>
</div>

<div class="toast" id="toast"></div>

<script src="shared/auth.js"></script>
<script src="shared/utils.js"></script>
<script src="shared/nav.js"></script>
<script>
(function(){
'use strict';

var metricsData = null, incidentsData = null, triageData = null;

// ---- Incidents ----
window.loadIncidents = function(){
  CC.api('incidents').then(function(d){
    if(!d)return;
    incidentsData=d;
    renderIncidents(d);
    renderStatus(d);
  }).catch(function(e){ CC.toast('Incidents: '+e.message, false); });
};

function renderStatus(d){
  var el=document.getElementById('status-badge');
  var n=(d&&d.incidents)?d.incidents.length:0;
  var cls,txt;
  if(n===0){cls='status-green';txt='All Clear';}
  else if(n>=5){cls='status-red';txt=n+' Problems';}
  else{cls='status-yellow';txt=n+' Problem'+(n>1?'s':'');}
  el.innerHTML='<span class="status-badge '+cls+'"><span class="dot"></span>'+txt+'</span>';
}

function renderIncidents(d){
  var box=document.getElementById('incidents-box');
  if(!d||!d.incidents||d.incidents.length===0){
    box.innerHTML='<div class="all-clear fade-in"><div class="title">All Clear</div><div class="sub">No active problem tickets</div></div>';
    return;
  }
  var h='<div class="incidents-grid fade-in">';
  d.incidents.forEach(function(i){
    var age=CC.ageH(i.createdAt);
    var ac=age>24?'age-critical':age>4?'age-warning':'age-ok';
    h+='<div class="incident-card '+ac+'">';
    h+='<div class="incident-header">';
    h+='<span class="incident-id"><a href="'+CC.ZD+i.problemId+'" target="_blank">ZD#'+i.problemId+'</a></span>';
    h+='<span class="age-pill '+ac+'">'+CC.relTime(i.createdAt)+'</span>';
    h+='</div>';
    h+='<div class="incident-subject">'+CC.esc(i.subject)+'</div>';
    h+='<div class="incident-meta">';
    if(i.jiraLinks&&i.jiraLinks.length>0){
      i.jiraLinks.forEach(function(j){
        h+='<span><span class="label">Jira:</span> <a href="'+CC.esc(j.url)+'" target="_blank"><strong>'+CC.esc(j.issueKey)+'</strong></a></span>';
      });
    }
    h+='<span><span class="label">Status:</span> <span class="value">'+CC.esc(i.status)+'</span></span>';
    h+='</div></div>';
  });
  h+='</div>';
  box.innerHTML=h;
}

// ---- Metrics ----
window.loadMetrics = function(){
  CC.api('metrics').then(function(d){
    if(!d)return;
    metricsData=d;
    renderStats(d);
    renderCharts(d);
    document.getElementById('header-sub').textContent=
      d.byDay&&d.byDay.length?d.byDay[0].day+' to '+d.byDay[d.byDay.length-1].day:'Current week';
    document.getElementById('last-updated').textContent='Updated '+CC.fmtTime(d.generatedAt);
  }).catch(function(e){ CC.toast('Metrics: '+e.message, false); });
};

function renderStats(d){
  var box=document.getElementById('stats-box');
  var cards=[
    {l:'Tickets This Week',v:CC.fmt(d.totalTickets),det:'Resolved: '+CC.fmt(d.resolvedTickets)},
    {l:'Avg Per Day',v:d.avgPerDay?d.avgPerDay.toFixed(1):'--',det:'7-day average'},
    {l:'Open Backlog',v:CC.fmt(d.openBacklog),det:'Unresolved tickets'},
    {l:'Triage Match Rate',v:triageData&&triageData.stats?triageData.stats.matchRate+'%':'--',det:triageData&&triageData.stats?'Triaged: '+CC.fmt(triageData.stats.total):''},
  ];
  var h='';
  cards.forEach(function(c){
    h+='<div class="stat-card fade-in"><div class="stat-label">'+CC.esc(c.l)+'</div><div class="stat-value">'+c.v+'</div><div class="stat-detail">'+CC.esc(c.det)+'</div></div>';
  });
  box.innerHTML=h;
}

function renderCharts(d){
  var box=document.getElementById('charts-box');
  var h='';
  // Tickets by day
  h+='<div class="chart-card fade-in"><div class="chart-title">Tickets by Day</div>';
  if(d.byDay&&d.byDay.length){
    var mx=Math.max.apply(null,d.byDay.map(function(x){return x.count;}));
    h+='<div class="bar-chart-v">';
    d.byDay.forEach(function(x){
      var pct=mx>0?(x.count/mx)*100:0;
      h+='<div class="bar-col"><div class="bar-val">'+x.count+'</div><div class="bar-fill" style="height:'+pct+'%"></div><div class="bar-lbl">'+CC.esc(CC.dayLbl(x.day))+'</div></div>';
    });
    h+='</div>';
  } else h+='<div class="no-data">No data</div>';
  h+='</div>';
  // By category
  h+=CC.hBar('By Category',d.byCategory);
  // By POS
  h+=CC.hBar('By POS',d.byPOS);
  box.innerHTML=h;
}

// ---- Triage ----
window.loadTriage = function(){
  CC.api('tickets?hours=24').then(function(d){
    if(!d)return;
    triageData=d;
    renderTriage(d);
  }).catch(function(e){ CC.toast('Triage: '+e.message, false); });
};

function renderTriage(d){
  var box=document.getElementById('triage-box');
  var tickets=(d&&d.tickets)?d.tickets:(d&&d.recentTickets)?d.recentTickets:[];
  if(!tickets.length){
    box.innerHTML='<div class="triage-card"><div class="no-data">No recent tickets</div></div>';
    return;
  }
  var h='<div class="triage-card fade-in"><div class="triage-wrap"><table>';
  h+='<thead><tr><th>Ticket</th><th>Subject</th><th>Status</th><th>Priority</th><th>Type</th><th>Actions</th></tr></thead><tbody>';
  tickets.slice(0,30).forEach(function(t){
    var id=t.id;
    var pri=(t.priority||'normal').toLowerCase();
    var pcls='p-'+pri;
    h+='<tr>';
    h+='<td class="td-ticket"><a href="'+CC.ZD+id+'" target="_blank">#'+id+'</a></td>';
    h+='<td class="td-subject" title="'+CC.esc(t.subject)+'">'+CC.esc(CC.trunc(t.subject,55))+'</td>';
    h+='<td><span class="td-cat">'+CC.esc(t.status||'--')+'</span></td>';
    h+='<td><span class="priority-badge '+pcls+'">'+CC.esc(pri)+'</span></td>';
    h+='<td class="td-cat">'+CC.esc(t.type||'ticket')+'</td>';
    h+='<td>';
    if(t.category){
      h+='<button class="btn btn-approve btn-sm" onclick="approveTicket('+id+',this)" title="Add triage note to ZD">Approve</button> ';
    }
    if(!t.problemId && incidentsData && incidentsData.incidents && incidentsData.incidents.length){
      h+='<button class="btn btn-link btn-sm" onclick="showLinkMenu('+id+',this)" title="Link to Problem ticket">Link</button>';
    }
    h+='</td></tr>';
  });
  h+='</tbody></table></div></div>';
  box.innerHTML=h;
}

// ---- Actions ----
window.approveTicket = function(ticketId, btn){
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span>';
  CC.api('approve',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, category:'Auto-triaged', suggestedAction:'Review triage suggestion'})
  }).then(function(d){
    if(d&&d.success){ CC.toast('Internal note added to #'+ticketId, true); btn.textContent='Done'; btn.disabled=true; }
    else { CC.toast('Failed', false); btn.classList.remove('loading'); btn.textContent='Approve'; }
  }).catch(function(e){ CC.toast(e.message, false); btn.classList.remove('loading'); btn.textContent='Approve'; });
};

window.showLinkMenu = function(ticketId, btn){
  var incidents = incidentsData ? incidentsData.incidents : [];
  if(!incidents.length){ CC.toast('No active incidents', false); return; }
  var menu='<select onchange="linkTicket('+ticketId+',this.value,this)" style="font-size:0.7rem;padding:2px;background:var(--bg-input);color:var(--text-primary);border:1px solid var(--border);border-radius:4px">';
  menu+='<option value="">Pick incident...</option>';
  incidents.forEach(function(i){
    var jira=i.jiraLinks&&i.jiraLinks.length?'('+i.jiraLinks[0].issueKey+')':'';
    menu+='<option value="'+i.problemId+'">ZD#'+i.problemId+' '+jira+' '+CC.esc(CC.trunc(i.subject,30))+'</option>';
  });
  menu+='</select>';
  btn.outerHTML=menu;
};

window.linkTicket = function(ticketId, problemId, sel){
  if(!problemId)return;
  sel.disabled=true;
  CC.api('link',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({ticketId:ticketId, problemId:parseInt(problemId,10)})
  }).then(function(d){
    if(d&&d.success){
      var jira=d.jiraLinks&&d.jiraLinks.length?' + '+d.jiraLinks[0].issueKey:'';
      CC.toast('Linked #'+ticketId+' to Problem #'+problemId+jira, true);
      sel.outerHTML='<span style="color:var(--av-green);font-size:0.7rem;font-weight:600">Linked</span>';
    } else { CC.toast('Link failed', false); sel.disabled=false; }
  }).catch(function(e){ CC.toast(e.message, false); sel.disabled=false; });
};

// ---- Refresh All ----
window.refreshAll = function(){
  var btn=document.getElementById('refresh-btn');
  btn.classList.add('loading');
  btn.innerHTML='<span class="spinner"></span> Refreshing...';
  Promise.all([
    CC.api('incidents').then(function(d){ if(d){incidentsData=d;renderIncidents(d);renderStatus(d);} }),
    CC.api('metrics').then(function(d){ if(d){metricsData=d;renderStats(d);renderCharts(d);document.getElementById('last-updated').textContent='Updated '+CC.fmtTime(d.generatedAt);} }),
    CC.api('tickets?hours=24').then(function(d){ if(d){triageData=d;renderTriage(d);} }),
  ]).then(function(){
    btn.classList.remove('loading');
    btn.textContent='Refresh All';
    CC.toast('All data refreshed', true);
  }).catch(function(){
    btn.classList.remove('loading');
    btn.textContent='Refresh All';
  });
};

// ---- Init ----
loadIncidents();
loadMetrics();
loadTriage();
setInterval(function(){ loadIncidents(); loadMetrics(); loadTriage(); }, 5*60*1000);

})();
</script>
</body>
</html>
